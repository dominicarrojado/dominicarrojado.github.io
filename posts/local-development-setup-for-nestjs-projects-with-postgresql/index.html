<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#2c2c34"/><link rel="icon" href="https://dominicarrojado.com/favicon.ico"/><link rel="manifest" href="https://dominicarrojado.com/manifest.json"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:image" content="https://dominicarrojado.com/images/pages/guides-tips-and-tricks-to-web-development.png"/><meta property="og:image:alt" content="Dominic Arrojado | Guides, Tips and Tricks to Web Development"/><meta property="og:image:type" content="image/png"/><meta property="og:image:width" content="2400"/><meta property="og:image:height" content="1254"/><meta property="og:site_name" content="Dominic Arrojado"/><link rel="preload" href="/fonts/Roboto-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Light.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-LightItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-LightItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Regular.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Italic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Medium.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-MediumItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Bold.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-BoldItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-BoldItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><title>Local development setup for NestJS projects with PostgreSQL | Dominic Arrojado</title><meta name="robots" content="index,follow"/><meta name="description" content="A quick way to get started with NestJS integrated with TypeScript, PostgreSQL and pgAdmin4 using Docker Compose"/><meta property="og:title" content="Local development setup for NestJS projects with PostgreSQL | Dominic Arrojado"/><meta property="og:description" content="A quick way to get started with NestJS integrated with TypeScript, PostgreSQL and pgAdmin4 using Docker Compose"/><meta property="og:url" content="https://dominicarrojado.com/posts/local-development-setup-for-nestjs-projects-with-postgresql/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2022-04-15T14:00:00Z"/><meta property="article:modified_time" content="2022-04-15T14:00:00Z"/><meta property="article:author" content="https://dominicarrojado.com/about/"/><link rel="canonical" href="https://dominicarrojado.com/posts/local-development-setup-for-nestjs-projects-with-postgresql/"/><meta name="next-head-count" content="39"/><link rel="preload" href="/_next/static/css/15a71a53b857db9b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/15a71a53b857db9b.css" data-n-g=""/><link rel="preload" href="/_next/static/css/82d01f71dc75279c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/82d01f71dc75279c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-6d9d10b8fc4eebc8.js" defer=""></script><script src="/_next/static/chunks/framework-433e73989db4e225.js" defer=""></script><script src="/_next/static/chunks/main-c51b0b3c89045435.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d6fd4562b5f27c31.js" defer=""></script><script src="/_next/static/chunks/216-1077b041778ead2e.js" defer=""></script><script src="/_next/static/chunks/466-2aafae0e90314603.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-101bdca647312681.js" defer=""></script><script src="/_next/static/0s-8t8OVWmO0YFCZwpUwT/_buildManifest.js" defer=""></script><script src="/_next/static/0s-8t8OVWmO0YFCZwpUwT/_ssgManifest.js" defer=""></script><script src="/_next/static/0s-8t8OVWmO0YFCZwpUwT/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><noscript>
            <iframe
              src="https://www.googletagmanager.com/ns.html?id=GTM-TSMLTPT"
              height="0"
              width="0"
              style="display: none; visibility: hidden"
            ></iframe>
          </noscript><div tabindex="-1" class="h-full outline-none"><header><a href="#main" tabindex="0" class="absolute -top-96 -left-96 w-px h-px text-center text-white overflow-hidden -z-50 focus:top-4 focus:inset-x-0 focus:m-auto focus:w-44 focus:h-auto focus:z-50 focus:sm:w-52 focus:xl:w-56">Skip to main content</a><a class="group fixed top-3.5 left-3.5 z-50 flex shadow-3xl border border-white bg-gray-750 bg-opacity-90 p-1.5 transform transition ease-in-out duration-500 hover:shadow-md hover:bg-opacity-100 motion-reduce:transition-none sm:top-4 sm:left-4 md:top-6 md:left-8 md:border-2 xl:left-9 xl:p-2 delay-700 opacity-0 -translate-y-full" aria-label="Dominic Arrojado logo" href="/"><svg viewBox="0 0 25750 29700" role="img" class="w-7 h-7 text-white transition-colors duration-300 sm:w-8 sm:h-8 md:w-10 md:h-10 xl:w-11 xl:h-11"><path fill="currentColor" d="M4850 19266H1025V2039l4600-129c2511 0 4500 735 5970 2206 1470 1470 2206 3423 2206 5854 0 6199-2985 9296-8951 9296zM4086 4719v11751c494 48 1025 72 1599 72 1543 0 2752-558 3624-1679s1310-2688 1310-4705c0-3684-1712-5524-5135-5524-329 0-795 28-1398 85zm17656 21711l-1437-3969h-6721l974-2655h4730l-2242-6854 1518-4167 7010 17645zM17826 435h3307L10351 29313H7044l4243-11322c1982-1513 2973-4055 2973-7627 0-171-4-340-11-506l3577-9423z"></path></svg></a><div class="fixed flex items-end top-3 right-1 z-50 sm:right-2 md:top-6 md:right-4 xl:top-7" data-testid="header-buttons"><button type="button" aria-expanded="false" aria-controls="dialog-menu" aria-haspopup="dialog" class="group flex items-center flex-col min-w-12 pt-3 pb-2 px-2 outline-none md:min-w-15.5 md:px-3 xl:min-w-18.5"><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 duration-1000 opacity-0 translate-x-1/2" style="transition-delay:500ms" data-testid="menu-stack"></div><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 mt-1.5 duration-1000 opacity-0 -translate-x-1/2" style="transition-delay:650ms" data-testid="menu-stack"></div><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 mt-1.5 duration-1000 opacity-0 translate-x-1/2" style="transition-delay:800ms" data-testid="menu-stack"></div><div class="mt-1.5 text-gray-400 text-3xs font-normal uppercase select-none dark:text-gray-300 transform transition-transform-opacity-color group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-gray-100 md:mt-2 md:text-2xs xl:text-xs duration-700 delay-1000 opacity-0 -translate-y-3">Menu</div></button></div><div class="hidden lg:block lg:fixed lg:bottom-3 lg:right-7 lg:z-40" data-testid="header-social"><ul class="max-w-full mt-10 flex flex-wrap justify-center lg:mt-0"><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2050ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-donate" href="https://www.paypal.com/paypalme/DominicArrojado" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Show your support and donate!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M256 416c114.9 0 208-93.1 208-208S370.9 0 256 0 48 93.1 48 208s93.1 208 208 208zM233.8 97.4V80.6c0-9.2 7.4-16.6 16.6-16.6h11.1c9.2 0 16.6 7.4 16.6 16.6v17c15.5.8 30.5 6.1 43 15.4 5.6 4.1 6.2 12.3 1.2 17.1L306 145.6c-3.8 3.7-9.5 3.8-14 1-5.4-3.4-11.4-5.1-17.8-5.1h-38.9c-9 0-16.3 8.2-16.3 18.3 0 8.2 5 15.5 12.1 17.6l62.3 18.7c25.7 7.7 43.7 32.4 43.7 60.1 0 34-26.4 61.5-59.1 62.4v16.8c0 9.2-7.4 16.6-16.6 16.6h-11.1c-9.2 0-16.6-7.4-16.6-16.6v-17c-15.5-.8-30.5-6.1-43-15.4-5.6-4.1-6.2-12.3-1.2-17.1l16.3-15.5c3.8-3.7 9.5-3.8 14-1 5.4 3.4 11.4 5.1 17.8 5.1h38.9c9 0 16.3-8.2 16.3-18.3 0-8.2-5-15.5-12.1-17.6l-62.3-18.7c-25.7-7.7-43.7-32.4-43.7-60.1.1-34 26.4-61.5 59.1-62.4zM480 352h-32.5c-19.6 26-44.6 47.7-73 64h63.8c5.3 0 9.6 3.6 9.6 8v16c0 4.4-4.3 8-9.6 8H73.6c-5.3 0-9.6-3.6-9.6-8v-16c0-4.4 4.3-8 9.6-8h63.8c-28.4-16.3-53.3-38-73-64H32c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h448c17.7 0 32-14.3 32-32v-96c0-17.7-14.3-32-32-32z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2200ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-youtube" href="https://www.youtube.com/channel/UCWwV__qrzg5BYCSwO91Xhxg" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Watch my tech videos!"><svg viewBox="0 0 576 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2350ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-linkedin" href="https://www.linkedin.com/in/dominic-arrojado-75ba03a9/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Let&#x27;s connect on LinkedIn!"><svg viewBox="0 0 448 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2500ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-github" href="https://github.com/dominicarrojado/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Follow me on GitHub!"><svg viewBox="0 0 496 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2650ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-email" href="mailto:dominicarrojado@gmail.com" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Email me!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li></ul></div></header><div id="main"></div><section class="relative flex flex-col justify-center bg-gray-550 py-28 px-6 text-center overflow-hidden dark:bg-gray-750 transform transition-transform ease-in-out duration-500 motion-reduce:transition-none sm:px-20 lg:px-32 min-h-96 -translate-y-full" data-testid="container"><div class="absolute top-0 left-0 w-full h-full bg-repeat bg-center invert-[.1] dark:invert-0 motion-safe:animate-slide transition-opacity duration-1250 delay-500 motion-reduce:transition-none opacity-0" style="background-image:url(&#x27;/images/bg/pattern.png&#x27;)" data-testid="background"></div><div class="overflow-hidden py-2" style="opacity:1"><h1 class="text-3xl font-bold text-white leading-tight transform transition duration-1000 delay-500 motion-reduce:transition-none sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl opacity-0 translate-y-full">Local development setup for NestJS projects with PostgreSQL</h1></div><div class="overflow-hidden" style="opacity:1"><p class="font-light text-white transform transition duration-1000 delay-1000 motion-reduce:transition-none xl:text-2xl opacity-0 translate-y-full">A quick way to get started with NestJS integrated with TypeScript, PostgreSQL and pgAdmin4 using Docker Compose</p></div></section><section class="pt-16 pb-20 px-6 sm:pt-20 sm:pb-24 sm:px-8 md:pt-24 md:pb-28 lg:px-10 xl:pt-28 xl:pb-32 transform transition-transform-opacity duration-1000 motion-reduce:transition-none delay-1500 opacity-0 translate-y-10" data-testid="section"><div class="w-11/12 max-w-screen-3xl -mt-8 mx-auto pb-8 sm:-mt-10 sm:pb-10 md:-mt-12 md:pb-12 lg:w-5/6"><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="4984498713" data-ad-format="auto" data-full-width-responsive="true" data-testid="ad-unit"></ins></div><div class="flex justify-between items-center w-11/12 max-w-screen-3xl mx-auto lg:w-5/6"><div class="mr-4 text-sm text-gray-400 sm:text-base xl:text-lg">Last Updated: <time dateTime="2022-04-15">April 15, 2022</time></div><div class="rounded py-0.5 px-1.5 bg-gray-200 text-2xs capitalize dark:bg-gray-600 md:py-1 md:px-2 md:text-xs xl:text-sm">technology</div></div><div class="w-11/12 max-w-screen-3xl mt-4 mx-auto lg:w-5/6"><a class="group inline-flex items-center font-normal select-none dark:hover:text-white transition-colors duration-300 hover:text-black group-hover:text-black motion-reduce:transition-none" target="_blank" rel="noopener noreferrer nofollow" href="https://youtu.be/pZNE1YMdbio"><svg viewBox="0 0 576 512" role="img" class="w-6 h-6 mr-2 text-gray-400 transition-colors duration-300 group-hover:text-red motion-reduce:transition-none dark:group-hover:text-white sm:w-7 sm:h-7 sm:mr-3 xl:w-8 xl:h-8"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg> <!-- -->Watch it on YouTube<svg viewBox="0 0 320 512" role="img" class="inline-block w-2 h-2 ml-2 text-black opacity-30 dark:text-white transform transition duration-300 group-hover:translate-x-1.5 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 sm:ml-2.5 md:w-3 md:h-3 md:ml-3 xl:w-3.5 xl:h-3.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div><article class="w-11/12 max-w-screen-3xl mx-auto prose dark:prose-dark sm:prose-lg lg:w-5/6 xl:prose-xl mt-8 sm:mt-10 xl:mt-14" data-clarity-region="article" data-testid="content"><h2>Introduction</h2>
<p>This is a guide on how to setup a local development for <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/">NestJS</a> (a progressive <a target="_blank" rel="noopener noreferrer nofollow" href="https://nodejs.org/en/">Node.js</a> framework) projects with <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.typescriptlang.org/">TypeScript</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postgresql.org/">PostgreSQL</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.pgadmin.org/">pgAdmin4</a> using <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/compose/">Docker Compose</a>. We&#x27;ll be using <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/">TypeORM</a> to connect and talk to our PostgreSQL database. This is your quick way to get started with Nest and it also involves extensions and libraries that helps us save time and energy when writing our code.</p>
<h2>Skip</h2>
<p>If you don&#x27;t want to go through the steps below and you just want to get the boilerplate to save time, you can <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/dominicarrojado/nestjs-postgres-boilerplate">clone it here</a> or run the <a target="_blank" rel="noopener noreferrer nofollow" href="https://git-scm.com/">git</a> command below:</p>
<pre><code class="hljs language-bash">git <span class="hljs-built_in">clone</span> git@github.com:dominicarrojado/nestjs-postgres-boilerplate.git my-app
</code></pre>
<p>Don&#x27;t forget to ⭐ and share the <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/dominicarrojado/nestjs-postgres-boilerplate">repo</a> if you like it!</p>
<h2>Prerequisites</h2>
<p>Upon writing this post, I assume that you have some server-side application development background and basic knowledge regarding <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.npmjs.com/">npm</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">yarn</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">JavaScript</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.typescriptlang.org/">TypeScript</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/">Docker</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/compose/">Docker Compose</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://nodejs.org/en/">Node.js</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/">NestJS</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/">TypeORM</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postgresql.org/">PostgreSQL</a>.</p>
<p>Please make sure to install <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">Yarn</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a> in your system if you haven&#x27;t. We use <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">Yarn</a> as our package manager, it&#x27;s just like <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.npmjs.com/">npm</a> but <em>faster</em>. While we use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/">Docker</a> throughout the development lifecycle for fast, easy and portable application development.</p>
<p>We&#x27;ll be using <a target="_blank" rel="noopener noreferrer nofollow" href="https://code.visualstudio.com/">Visual Studio Code</a> as our <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Integrated_development_environment">IDE</a> in setting this local development setup as we will utilize a few extensions from their <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/vscode">marketplace</a>.</p>
<p>You can also use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postman.com/">Postman</a> to interact with the API but that&#x27;s optional as this won&#x27;t be a full Nest tutorial.</p>
<h2>Initialize your project</h2>
<p>Setting up a new project is quite simple with the <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/cli/overview">Nest CLI</a>. With <code>yarn</code> installed, you can create a new Nest project with the following commands in your OS terminal:</p>
<pre><code class="hljs language-bash">yarn global add @nestjs/cli
nest new my-app
</code></pre>
<p>Choose <code>yarn</code> as the package manager.</p>
<p>Once installed, let&#x27;s run our project to see if everything is working fine by executing the command below:</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">cd</span> my-app
yarn start
</code></pre>
<p>Once the application is running, open your browser and go to <code>http://localhost:3000/</code>. You should see a <code>Hello World!</code> message.</p>
<p>To watch for changes in your files, you can run the following command instead to start the application:</p>
<pre><code class="hljs language-bash">yarn start:dev
</code></pre>
<p>This command will watch your files, when you have changes, it will automatically start recompiling and reloading the server. That&#x27;s great for local development!</p>
<p>To build and run our Nest application for production, you can simply run the following command:</p>
<pre><code class="hljs language-bash">yarn build
yarn start:prod
</code></pre>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Install extensions in Visual Studio Code</h2>
<p>Open the created project in your Visual Studio Code. Let&#x27;s install <a target="_blank" rel="noopener noreferrer nofollow" href="https://prettier.io/">Prettier</a>, it&#x27;s a code formatter that formats the code for us when we save file changes which is a time-saver.</p>
<p>Click on the &quot;Extensions&quot; tab and look for &quot;Prettier&quot; and install it. You can also install it via this <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode">link</a>.</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>After Prettier is installed, we still need to enable the formatting feature by updating our settings in Visual Studio Code. Let&#x27;s create a folder in the root directory and name it <code>.vscode</code>. Then, create a file inside it and name it <code>settings.json</code>. Then update the created file with the code below:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;editor.formatOnSave&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">&quot;editor.defaultFormatter&quot;</span>: <span class="hljs-string">&quot;esbenp.prettier-vscode&quot;</span>,
  <span class="hljs-attr">&quot;editor.tabSize&quot;</span>: <span class="hljs-number">2</span>
}
</code></pre>
<p>Feel free to modify <code>editor.tabSize</code> as that can be changed according to your preference.</p>
<p>When we created a new Nest project, it already includes <code>.prettierrc</code> which is the config for Prettier to follow when formatting the code. These configs can be updated according to your preference.</p>
<p>Alright, once the changes are done. That should make our Prettier work.</p>
<p>You can also install <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">ESLint</a> extension in Visual Studio Code to help with the linting checks.</p>
<h2>Dockerfile</h2>
<p>A <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> is text document that contains the instructions for Docker to assemble or build an image.</p>
<p>Let&#x27;s create a <code>Dockerfile</code> in the root folder of our application and add the following code below:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-comment"># syntax=docker/dockerfile:1</span>

<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16.14</span>.<span class="hljs-number">2</span>-alpine
<span class="hljs-keyword">ENV</span> NODE_ENV=production

<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span>

<span class="hljs-keyword">COPY</span><span class="bash"> [ <span class="hljs-string">&quot;package.json&quot;</span>, <span class="hljs-string">&quot;yarn.lock*&quot;</span>, <span class="hljs-string">&quot;./&quot;</span> ]</span>

<span class="hljs-keyword">RUN</span><span class="bash"> yarn install --frozen-lockfile --production</span>

<span class="hljs-keyword">COPY</span><span class="bash"> . .</span>

<span class="hljs-keyword">RUN</span><span class="bash"> yarn global add @nestjs/cli</span>
<span class="hljs-keyword">RUN</span><span class="bash"> yarn build</span>

<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;start:prod&quot;</span> ]</span>
</code></pre>
<p>If you&#x27;re new to Docker or you need an explanation of what each line does, you can refer to the <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/language/nodejs/build-images/#create-a-dockerfile-for-nodejs">section here</a> from <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/">Docker Documentation</a>, they explained it really well on while walking you through the process of creating a Dockerfile for Node.js. The <code>Dockerfile</code> we have created here is based from their example.</p>
<p>Next, let&#x27;s create a <code>.dockerignore</code> file in the root folder with the following content:</p>
<pre><code class="hljs language-ebnf"><span class="hljs-attribute">node_modules
dist</span>
</code></pre>
<p>Files or directories added in this file will get excluded in the build context. This will increase the build&#x27;s performance and improve the context load time.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Build image</h2>
<p>Now that we&#x27;ve created our <code>Dockerfile</code>, let&#x27;s build our image. You are able to do this by the <code>docker build</code> command. The <code>docker build</code> command builds Docker images from a <code>Dockerfile</code> and a &quot;context&quot;. A build&#x27;s context is the set of files located in the specified PATH or URL. The Docker build process can access any of the files located in the context.</p>
<p>The build command optionally takes a <code>--tag</code> flag. The tag is used to set the name of the image and an optional tag in the format <code>name:tag</code>. We&#x27;ll leave off the optional &quot;tag&quot; for now to help simplify things. If you do not pass a tag, Docker will use &quot;latest&quot; as its default tag. You&#x27;ll see this in the last line of the build output.</p>
<p>Let&#x27;s build our first Docker image. Do remember to start your Docker Desktop application before executing the command below:</p>
<pre><code class="hljs language-bash">docker build --tag nest-docker .
</code></pre>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>If you open your Docker Desktop, you&#x27;ll see our <code>nest-docker</code> image in the &quot;Images&quot; tab.</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<h2>Run our image as a container</h2>
<p>Now that we have an image, we can run that image and see if our application is running correctly.</p>
<p>A container is a normal operating system process except that this process is isolated and has its own file system, its own networking, and its own isolated process tree separate from the host.</p>
<p>To run an image inside of a container, we use the <code>docker run</code> command. Let&#x27;s start our image and make sure it is running correctly. Execute the following command in your terminal.</p>
<pre><code class="hljs language-bash">docker run --detach --publish 3000:3000 nest-docker
</code></pre>
<p>We have 2 parameters in this command, that&#x27;s <code>--detach</code> and <code>--publish 3000:3000</code>. So remember that contianers runs in isolation, hence we are not able to connect to it unless we publish it. To publish a port for our container, we used the <code>--publish</code> flag (-p for short) on the docker run command. The format of the <code>--publish</code> command is <code>[host port]:[container port]</code>. We can then access our application running in the <code>container port</code> via the <code>host port</code>. While <code>--detach</code> basically runs our container in detached mode or in the background so that our terminal (which where we ran the command) will not have it connected.</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>Now that the application is running, open your browser and go to <code>http://localhost:3000/</code>. You should see the same <code>Hello World!</code> message.</p>
<p>Now we have successfully containerized our application.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Multi-stage builds</h2>
<p>Currently, we only containerized our application for <strong>production</strong>. But how about for (local) <strong>development</strong>? <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds">Multi-stage builds</a> is the way to go. With multi-stage builds, we can use multiple <code>FROM</code> statements in our Dockerfile. Each <code>FROM</code> instruction can use a different base, and each of them begins a new stage of the build.</p>
<p>Let&#x27;s update our <code>Dockerfile</code> with the following code:</p>
<pre><code class="hljs language-dockerfile"><span class="hljs-comment"># syntax=docker/dockerfile:1</span>

<span class="hljs-keyword">FROM</span> node:<span class="hljs-number">16.14</span>.<span class="hljs-number">2</span>-alpine AS base

<span class="hljs-keyword">WORKDIR</span><span class="bash"> /app</span>

<span class="hljs-keyword">COPY</span><span class="bash"> [ <span class="hljs-string">&quot;package.json&quot;</span>, <span class="hljs-string">&quot;yarn.lock*&quot;</span>, <span class="hljs-string">&quot;./&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> base AS dev
<span class="hljs-keyword">ENV</span> NODE_ENV=development
<span class="hljs-keyword">RUN</span><span class="bash"> yarn install --frozen-lockfile</span>
<span class="hljs-keyword">COPY</span><span class="bash"> . .</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;start:dev&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> base AS prod
<span class="hljs-keyword">ENV</span> NODE_ENV=production
<span class="hljs-keyword">RUN</span><span class="bash"> yarn install --frozen-lockfile --production</span>
<span class="hljs-keyword">COPY</span><span class="bash"> . .</span>
<span class="hljs-keyword">RUN</span><span class="bash"> yarn global add @nestjs/cli</span>
<span class="hljs-keyword">RUN</span><span class="bash"> yarn build</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;start:prod&quot;</span> ]</span>
</code></pre>
<p>Now we can build the image with a target using the <code>docker build</code> command with a <code>--target</code> parameter. Let&#x27;s use <code>dev</code> as our target to build and run our application for local development.</p>
<pre><code class="hljs language-bash">docker build --target dev --tag nest-docker .
docker run --detach --publish 3000:3000 nest-docker
</code></pre>
<p>This should run the application properly in <code>dev</code> mode.</p>
<h2>Docker Compose</h2>
<p>Just using <code>Dockerfile</code> for our local development is not productive enough yet. When we make changes to our application, we will need to stop it, rebuild it and run it again. Also later on, we will need to configure the database to connect and use in our application. This whole process can be optimized using <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/compose/">Docker Compose</a>. Docker Compose is a tool for defining and running multi-container Docker applications. With Docker Compose, you use a <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/YAML">YAML</a> file to configure your application&#x27;s services. Then, with a single command, you create and start all the services from your configuration. That sounds great, right?</p>
<p>Let&#x27;s go ahead and create a <code>docker-compose.yml</code> file in the root folder and add the following code:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.9&#x27;</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">dev</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">3000</span><span class="hljs-string">:3000</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./src:/app/src</span>
</code></pre>
<p>Most of the keys here should be familiar to you except the <code>volumes</code> key. The <code>volumes</code> key mounts the project directory (current directory, <code>./src</code>) on the host to <code>/app/src</code> directory inside the container, allowing you to modify the code on the fly, without having to rebuild the image.</p>
<p>Once the changes are saved, let&#x27;s test it out by running the following command:</p>
<pre><code class="hljs language-bash">docker-compose build
docker-compose up

<span class="hljs-comment"># OR</span>

docker-compose up --build
</code></pre>
<p>Do remember to stop the docker image we ran previously via the Docker Desktop as we cannot run two applications on the same port.</p>
<p>Now try making a change within the application code, go to <code>src/app.service.ts</code> and a few more <code>!</code> to the <code>Hello World</code> message. Once you save the changes, it will automatically send the new code to the container and that will trigger the rebuild of the application as it is running via <code>yarn start:dev</code> or <code>nest start --watch</code>. Awesome!</p>
<p>Let&#x27;s add this <code>docker-compose</code> command in our <code>package.json</code> scripts so that we can easily type and remember the command in a shorter form:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;my-app&quot;</span>,
  ...
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    ...
    <span class="hljs-attr">&quot;docker-compose:dev&quot;</span>: <span class="hljs-string">&quot;docker-compose up --build&quot;</span>
  },
  ...
}
</code></pre>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>PostgreSQL and pgAdmin4</h2>
<p>In this post, we&#x27;ll use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postgresql.org/">PostgreSQL</a> as our database and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.pgadmin.org/">pgAdmin4</a> for our database admin tool to complete our local development setup.</p>
<p>Let&#x27;s update our <code>docker-compose.yml</code> to include their respective docker images:</p>
<pre><code class="hljs language-yml"><span class="hljs-string">...</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-string">...</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">5432</span><span class="hljs-string">:5432</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>

  <span class="hljs-attr">dbadmin:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">dpage/pgadmin4</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">5050</span><span class="hljs-string">:80</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">PGADMIN_DEFAULT_EMAIL:</span> <span class="hljs-string">admin@admin.com</span>
      <span class="hljs-attr">PGADMIN_DEFAULT_PASSWORD:</span> <span class="hljs-string">pgadmin4</span>
</code></pre>
<p>PostgreSQL image runs on port <code>5432</code> by default and we are just exposing the same port for our application to connect to. The only environment variable required is <code>POSTGRES_PASSWORD</code>, the rest are optional or will use the default values. Hence, we have defined a password here. You can read more about the other environment variables for PostgreSQL <a target="_blank" rel="noopener noreferrer nofollow" href="https://hub.docker.com/_/postgres">here</a>. The default value for <code>POSTGRES_USERNAME</code> and <code>POSTGRES_DATABASE</code> would be <code>postgres</code>.</p>
<p>On the other hand, pgAdmin4 image runs on port <code>80</code> by default and we are making it accessible outside the container on port <code>5050</code>. There are two environment variables required: <code>PGADMIN_DEFAULT_EMAIL</code> and <code>PGADMIN_DEFAULT_PASSWORD</code>. You can read more about the other environment variables for pgAdmin4 <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html">here</a>.</p>
<p>We can control the order of service startup and shutdown with the <code>depends_on</code> option. Hence we have added <code>db</code> as a dependency for our <code>app</code> service.</p>
<p>Let&#x27;s build and run our Docker Compose and everything should be working fine:</p>
<pre><code class="hljs language-bash">yarn docker-compose:dev
</code></pre>
<p>Once all the environments are up and running, open your browser and go to <code>http://localhost:5050/</code>. You will be redirected to log in to pgAdmin4. Type in the default email and password we have provided in the <code>docker-compose.yml</code>.</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>After successfully logging in, do a right-click on the &quot;Servers&quot; located at the left-hand side of the portal then click &quot;Register - Server&quot;. It will open up a modal, under the &quot;General&quot; tab, give the server a name (e.g. &quot;Nest Docker&quot;). Then, go to the &quot;Connection&quot; tab and input the following:</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>Hit &quot;Save&quot; and if there was no error means that our pgAdmin4 was able to connect to our PostgreSQL database successfully. The &quot;Nest Docker&quot; would be added under the &quot;Servers&quot;, and you can go through that to see and interact with the database. Here&#x27;s how you can go to the tables: <code>Servers</code> -&gt; <code>Nest Docker</code> -&gt; <code>postgres</code> -&gt; <code>Schemas</code> -&gt; <code>public</code> -&gt; <code>Tables</code>.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>TypeORM</h2>
<p>Let&#x27;s continue and set up a database connection to our Nest application. We&#x27;ll be using <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/">TypeORM</a> which is an <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> that can help us develop any kind of application that uses databases in a JavaScript or TypeScript friendly way to communicate to the database rather than sending plain queries directly. It also handles a lot of things automatically such as database handling, data types, relations, etc. It also has database abstraction and they support a number of databases, that means we&#x27;re not tied to a specific database, we can use PostgreSQL now and maybe use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.mongodb.com/">MongoDB</a> tomorrow by just changing the configuration when initializing TypeORM and minor changes to the shape of your entities.</p>
<p>To use TypeORM in Nest. First, install the following dependencies:</p>
<pre><code class="hljs language-bash">yarn add @nestjs/typeorm typeorm@0.2 pg
</code></pre>
<blockquote>
<p>Note that we&#x27;re using TypeORM v0.2, which isn&#x27;t the latest version of TypeORM. The latter has substantial modifications and duplicate methods which are used on this post. You can read about <a target="_blank" rel="noopener noreferrer nofollow" href="mailto:typeorm@0.3.0">typeorm@0.3.0</a> changes <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/typeorm/typeorm/releases/tag/0.3.0">on their repository</a>.</p>
</blockquote>
<p>When installing <code>typeorm@0.2</code>, you might need to move <code>@types/node</code> from <code>devDependencies</code> to <code>dependencies</code> as a workaround for <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/typeorm/typeorm/issues/8951">this error</a>.</p>
<pre><code class="hljs language-bash">yarn remove @types/node
yarn add @types/node
</code></pre>
<p>Once the installation process is complete, we can import the <code>TypeOrmModule</code> into the root <code>AppModule</code> in <code>src/app.module.ts</code> and configure the database connection:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { TypeOrmModule } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/typeorm&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    TypeOrmModule.forRoot({
      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;postgres&#x27;</span>,
      <span class="hljs-attr">host</span>: <span class="hljs-string">&#x27;db&#x27;</span>,
      <span class="hljs-attr">port</span>: <span class="hljs-number">5432</span>,
      <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;postgres&#x27;</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;postgres&#x27;</span>,
      <span class="hljs-attr">database</span>: <span class="hljs-string">&#x27;postgres&#x27;</span>,
      <span class="hljs-attr">autoLoadEntities</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">true</span>,
    }),
  ],
  ...
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppModule</span> </span>{}
</code></pre>
<p>Once you save the changes and run our application again, it should be all &quot;green&quot; in the terminal logs and that means the connection of the Nest application to our database is successful. Let&#x27;s verify this by creating a <code>Users</code> module along with the controller and service using Nest CLI.</p>
<pre><code class="hljs language-bash">nest g module users
nest g controller users --no-spec
nest g service users --no-spec
</code></pre>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<p>Next, we need to create an entity for <code>User</code>. In TypeORM, an entity is a class that maps to a database table (or collection when using MongoDB). Create a file <code>src/users/user.entity.ts</code> and add the following code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Column, Entity, PrimaryGeneratedColumn } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typeorm&#x27;</span>;

<span class="hljs-meta">@Entity</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>()
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-meta">@Column</span>()
  <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>()
  <span class="hljs-attr">lastName</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;
}
</code></pre>
<p>TypeORM supports the <strong>repository design pattern</strong>, so each entity has its own repository. These repositories can be obtained from the database connection.</p>
<p>To begin using the <code>User</code> entity, we need to let TypeORM know about it by inserting it into the array in the module <code>forFeature()</code> method argument and import it in the users module <code>src/users/users.module.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { TypeOrmModule } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { User } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.entity&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [TypeOrmModule.forFeature([User])],
  ...
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersModule</span> </span>{}
</code></pre>
<p>The user module uses the <code>forFeature()</code> method to define which repositories are registered in the current scope. With that in place, we can inject the <code>UsersRepository</code> into the <code>UsersService</code> using the <code>@InjectRepository()</code> decorator in <code>src/users/users.service.ts</code>:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { InjectRepository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { Repository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { User } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.entity&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersService</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectRepository</span>(User) <span class="hljs-keyword">private</span> usersRepository: Repository&lt;User&gt;
  </span>)</span> {}

  getAllUsers(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">Array</span>&lt;User&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.usersRepository.find({});
  }
}
</code></pre>
<p>Now to expose a <code>GET</code> request handler in our application to get all the users, let&#x27;s update our users controller <code>src/users/users.controller.ts</code>:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Controller, Get } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { User } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./user.entity&#x27;</span>;
<span class="hljs-keyword">import</span> { UsersService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./users.service&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;users&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UsersController</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> usersService: UsersService</span>)</span> {}

  <span class="hljs-meta">@Get</span>()
  getAllUsers(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">Array</span>&lt;User&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.usersService.getAllUsers();
  }
}
</code></pre>
<p>You can open your Postman API client (or simply open your browser) and do a <code>GET</code> request to <code>http://localhost:3000/users</code>.</p>
<p>It should return a status of <code>200 OK</code> and return you an empty array <code>[]</code>.</p>
<p>If you still don&#x27;t trust it, create a new row in our <code>user</code> table using pgAdmin4.</p>
<div class="lazyload-wrapper "><div class="lazyload-placeholder"></div></div>
<p>And if you repeat the same <code>GET</code> request, it should now return you an array with the user object:</p>
<pre><code class="hljs language-json">[{ <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">&quot;firstName&quot;</span>: <span class="hljs-string">&quot;Dominic&quot;</span>, <span class="hljs-attr">&quot;lastName&quot;</span>: <span class="hljs-string">&quot;Arrojado&quot;</span>, <span class="hljs-attr">&quot;isActive&quot;</span>: <span class="hljs-literal">true</span> }]
</code></pre>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>ConfigModule</h2>
<p>There&#x27;s another thing we need to do, so remember the values we used in initializing <code>TypeOrmModule</code>, passing configuration settings such as <code>host</code>, <code>port</code>, <code>username</code>, etc. Applications often run in different environments. Depending on the environment, different configuration settings should be used. Best practice is to store configuration variables in the environment.</p>
<p>In Node.js applications, it&#x27;s common to use <code>.env</code> files, holding key-value pairs where each key represents a particular value, to represent each environment. Running an app in different environments is then just a matter of swapping in the correct <code>.env</code> file.</p>
<p>A good approach for using this technique in Nest is to create a <code>ConfigModule</code> that exposes a <code>ConfigService</code> which loads the appropriate .env file. While you may choose to write such a module yourself, for convenience Nest provides the <code>@nestjs/config</code> package out-of-the box.</p>
<p>To begin using it, let&#x27;s install the required dependency:</p>
<pre><code class="hljs language-bash">yarn add @nestjs/config cross-env
</code></pre>
<p>Then head over to <code>src/app.module.ts</code> and import the <code>ConfigModule</code> here:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { ConfigModule, ConfigService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/config&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    ConfigModule.forRoot({
      <span class="hljs-attr">envFilePath</span>: [<span class="hljs-string">`stage.<span class="hljs-subst">${process.env.STAGE}</span>.env`</span>],
    }),
    TypeOrmModule.forRootAsync({
      <span class="hljs-attr">imports</span>: [ConfigModule],
      <span class="hljs-attr">inject</span>: [ConfigService],
      <span class="hljs-attr">useFactory</span>: <span class="hljs-keyword">async</span> (configService: ConfigService) =&gt; {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;postgres&#x27;</span>,
          <span class="hljs-attr">host</span>: configService.get(<span class="hljs-string">&#x27;DB_HOST&#x27;</span>),
          <span class="hljs-attr">port</span>: configService.get(<span class="hljs-string">&#x27;DB_PORT&#x27;</span>),
          <span class="hljs-attr">username</span>: configService.get(<span class="hljs-string">&#x27;DB_USERNAME&#x27;</span>),
          <span class="hljs-attr">password</span>: configService.get(<span class="hljs-string">&#x27;DB_PASSWORD&#x27;</span>),
          <span class="hljs-attr">database</span>: configService.get(<span class="hljs-string">&#x27;DB_DATABASE&#x27;</span>),
          <span class="hljs-attr">autoLoadEntities</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">true</span>,
        };
      },
    }),
    UsersModule,
  ],
  ...
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppModule</span> </span>{}
</code></pre>
<p>In order to use the <code>ConfigModule</code> when initializing the <code>TypeOrmModule</code>, we&#x27;ll need to switch from using <code>forRoot</code> to <code>forRootAsync</code> and take advantage of the dependency injection as written above.</p>
<p>We&#x27;ll be using <code>STAGE</code> from the environment variables as the definition on which <code>.env</code> file will be loaded. Go ahead and create <code>stage.dev.env</code> and add the following config (you can create a file <code>stage.prod.env</code> later when you&#x27;re ready to deploy your application to production):</p>
<pre><code class="hljs language-ini"><span class="hljs-attr">PORT</span>=<span class="hljs-number">3000</span>
<span class="hljs-attr">DB_HOST</span>=db
<span class="hljs-attr">DB_PORT</span>=<span class="hljs-number">5432</span>
<span class="hljs-attr">DB_USERNAME</span>=postgres
<span class="hljs-attr">DB_PASSWORD</span>=postgres
<span class="hljs-attr">DB_DATABASE</span>=postgres
</code></pre>
<p>Then update <code>package.json</code> to include <code>STAGE</code> environment variable depending on the script:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;my-app&quot;</span>,
  ...
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    ...
    <span class="hljs-attr">&quot;start:dev&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev nest start --watch&quot;</span>,
    <span class="hljs-attr">&quot;start:debug&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev nest start --debug --watch&quot;</span>,
    <span class="hljs-attr">&quot;start:prod&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=prod node dist/main&quot;</span>,
    ...
    <span class="hljs-attr">&quot;test&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest&quot;</span>,
    <span class="hljs-attr">&quot;test:watch&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest --watch&quot;</span>,
    <span class="hljs-attr">&quot;test:cov&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest --coverage&quot;</span>,
    ...
  },
  ...
}
</code></pre>
<p>Here we are using <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/kentcdodds/cross-env"><code>cross-env</code></a> which allows us to have a single command without worrying about setting or using the environment variable properly depending on the platform (e.g. <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Microsoft_Windows">Windows</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/MacOS">MacOS</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Linux">Linux</a>).</p>
<p>Let&#x27;s also update <code>main.ts</code> to use the <code>PORT</code> from the environment variables:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Logger } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { NestFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/core&#x27;</span>;
<span class="hljs-keyword">import</span> { AppModule } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./app.module&#x27;</span>;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bootstrap</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> Logger();
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> NestFactory.create(AppModule);
  <span class="hljs-keyword">const</span> port = process.env.PORT;

  <span class="hljs-keyword">await</span> app.listen(port);

  logger.log(<span class="hljs-string">`Application listening on port <span class="hljs-subst">${port}</span>`</span>);
}
bootstrap();
</code></pre>
<p>Run the Docker Compose environments again and everything should work fine as before.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Config schema validation</h2>
<p>It is standard practice to throw an exception during application startup if required environment variables haven&#x27;t been provided or if they don&#x27;t meet certain validation rules. The <code>@nestjs/config</code> package enables two different ways to do this as mentioned <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/techniques/configuration#schema-validation">here</a>. <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/sideway/joi">Joi</a> is one of them which is what we&#x27;re going to use.</p>
<p>To use Joi, we must install Joi package:</p>
<pre><code class="hljs language-bash">yarn add joi
</code></pre>
<p>Next, create the file <code>src/config.schema.ts</code> in the root folder with the following content:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> Joi <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;joi&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> configValidationSchema = Joi.object({
  <span class="hljs-attr">STAGE</span>: Joi.string().required(),
  <span class="hljs-attr">PORT</span>: Joi.number().default(<span class="hljs-number">3000</span>).required(),
  <span class="hljs-attr">DB_HOST</span>: Joi.string().required(),
  <span class="hljs-attr">DB_PORT</span>: Joi.number().default(<span class="hljs-number">5432</span>).required(),
  <span class="hljs-attr">DB_USERNAME</span>: Joi.string().required(),
  <span class="hljs-attr">DB_PASSWORD</span>: Joi.string().required(),
  <span class="hljs-attr">DB_DATABASE</span>: Joi.string().required(),
});
</code></pre>
<p>Then let&#x27;s make use of this by passing it in the <code>ConfigModule</code> option <code>validationSchema</code> in <code>src/app.module.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { configValidationSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.schema&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    ConfigModule.forRoot({
      <span class="hljs-attr">envFilePath</span>: [<span class="hljs-string">`stage.<span class="hljs-subst">${process.env.STAGE}</span>.env`</span>],
      <span class="hljs-attr">validationSchema</span>: configValidationSchema,
    }),
    ...
  ],
  ...
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppModule</span> </span>{}
</code></pre>
<p>That&#x27;s all you need to do. Try removing <code>DB_USERNAME</code> in <code>stage.dev.env</code> and run the Docker Compose environments. You&#x27;ll get an error in the end stating: <code>Error: Config validation error: &quot;DB_USERNAME&quot; is required</code>. That&#x27;s really helpful for knowing what went wrong while trying to run your application instead of getting a generic error <code>Unable to connect to the database</code> if we didn&#x27;t do the config schema validation otherwise.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Production and test environments</h2>
<p>To finish off our local development setup, we want to be able to run tests using Docker Compose as well.</p>
<p>First, let&#x27;s update the <code>Dockerfile</code> to include the 3 scripts that runs the test:</p>
<pre><code class="hljs language-dockerfile">...
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;start:dev&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> dev AS test
<span class="hljs-keyword">ENV</span> NODE_ENV=test
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;test&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> test AS test-cov
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;test:cov&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> test AS test-watch
<span class="hljs-keyword">ENV</span> GIT_WORK_TREE=/app GIT_DIR=/app/.git
<span class="hljs-keyword">RUN</span><span class="bash"> apk add git</span>
<span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;yarn&quot;</span>, <span class="hljs-string">&quot;test:watch&quot;</span> ]</span>

<span class="hljs-keyword">FROM</span> base AS prod
...
</code></pre>
<p>Note that for <code>test:watch</code> to know what has change within the application code, it relies on <a target="_blank" rel="noopener noreferrer nofollow" href="https://git-scm.com/">git</a>, so we had some additional instructions for it.</p>
<p>Let&#x27;s create <code>production.yml</code> in the root folder with the following content:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">prod</span>
</code></pre>
<p>It doesn&#x27;t contain much as we only want to change the target because this will be appended to the original <code>docker-compose.yml</code>.</p>
<p>Then create <code>test.yml</code> in the root folder with the following content:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">test</span>
</code></pre>
<p>Then create <code>test-cov.yml</code> in the root folder with the following content:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">test-cov</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./coverage:/app/coverage</span>
</code></pre>
<p>You should already be familiar with <code>volumes</code>. Here, we we are basically syncing the <code>coverage</code> folder so that the coverage files generated from the application container will be synced with our current directory. Useful for <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/CI/CD"><code>CI/CD</code></a> where you need to upload the test coverage to a service such as <a target="_blank" rel="noopener noreferrer nofollow" href="https://about.codecov.io/"><code>codecov</code></a>.</p>
<p>Then create <code>test-watch.yml</code> in the root folder with the following content:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">test-watch</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">.git:/app/.git/</span>
</code></pre>
<p>Same as above. Here, we are syncing the <code>.git</code> folder from our current directory with the <code>.git</code> folder of the application container. That is how it will know what files were changed in the application code and only run the test related to those changes.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<p>Let&#x27;s also move the <code>dbadmin</code> service block from <code>docker-compose.yml</code> to a new separate file called <code>dbadmin.yml</code> as it will only be utilized during <code>development</code> but we don&#x27;t need to that service when we&#x27;re just running tests.</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">dbadmin:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">dpage/pgadmin4</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">5050</span><span class="hljs-string">:80</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">PGADMIN_DEFAULT_EMAIL:</span> <span class="hljs-string">admin@admin.com</span>
      <span class="hljs-attr">PGADMIN_DEFAULT_PASSWORD:</span> <span class="hljs-string">pgadmin4</span>
</code></pre>
<p>The updated <code>docker-compose.yml</code> should look like this now:</p>
<pre><code class="hljs language-yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.9&#x27;</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
      <span class="hljs-attr">target:</span> <span class="hljs-string">dev</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">3000</span><span class="hljs-string">:3000</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./src:/app/src</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span>

  <span class="hljs-attr">db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">5432</span><span class="hljs-string">:5432</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">postgres</span>
</code></pre>
<p>Lastly, update the <code>package.json</code> to add new scripts and utilize these new Docker Compose targets:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;my-app&quot;</span>,
  ...
  <span class="hljs-attr">&quot;scripts&quot;</span>: {
    <span class="hljs-attr">&quot;test&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest --runInBand&quot;</span>,
    <span class="hljs-attr">&quot;test:watch&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest --runInBand --watch&quot;</span>,
    <span class="hljs-attr">&quot;test:cov&quot;</span>: <span class="hljs-string">&quot;cross-env STAGE=dev jest --runInBand --coverage&quot;</span>,
    ...
    <span class="hljs-attr">&quot;docker-compose:dev&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f dbadmin.yml up --build&quot;</span>,
    <span class="hljs-attr">&quot;docker-compose:test&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f test.yml up --build --exit-code-from app&quot;</span>,
    <span class="hljs-attr">&quot;docker-compose:test:cov&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f test-cov.yml up --build --exit-code-from app&quot;</span>,
    <span class="hljs-attr">&quot;docker-compose:test:watch&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f test-watch.yml up --build&quot;</span>,
    <span class="hljs-attr">&quot;docker-compose:prod&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f production.yml -f dbadmin.yml up --build&quot;</span>,
    <span class="hljs-attr">&quot;docker-compose:prod:build-only&quot;</span>: <span class="hljs-string">&quot;docker-compose -f docker-compose.yml -f production.yml build&quot;</span>
  },
  ...
}
</code></pre>
<p>In the changes, we added <code>--runInBand</code> parameter to the scripts <code>test</code>, <code>test:watch</code> and <code>test:cov</code> found in <code>package.json</code>. This is done so we can run all tests serially for end-to-end testing that interacts with a database in docker compose, we don&#x27;t want two or more test cases running in parallel where there&#x27;s only 1 database as it might affect expected test results.</p>
<p>Also, with the <code>-f</code> option, we are able to use a second configuration file along with the original <code>docker-compose.yml</code>. For <code>docker-compose:test</code> and <code>docker-compose:test:cov</code>, we have a special option <code>--exit-code-from</code>, that&#x27;s because we don&#x27;t want the services in the Docker Compose to keep running even after completing all the tests, so we should ideally exit from <code>app</code>, which is the name of our Nest application container in the <code>docker-compose.yml</code>, and stop all the services.</p>
<div><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="3748487753" data-ad-format="fluid" data-ad-layout="in-article" data-full-width-responsive="true" data-testid="ad-unit"></ins></div>
<h2>Final words</h2>
<p>Well, there you have it! You now have a full-fledged local development setup. Go ahead and start coding your Nest applications from this setup! I hope this was helpful for you, do share this post if you feel that it will be helpful for someone else too. By the way, I did <a target="_blank" href="/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1/">a post</a> on how to build an application using NestJS framework leveraging on this setup in case you&#x27;re intestered. Thanks for reading ~</p>
<h2>Online references</h2>
<ul>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/">Nest Documentation</a></li>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/">Docker Docs</a></li>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://hub.docker.com/_/postgres">PostgreSQL in Dockerhub</a></li>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://hub.docker.com/r/dpage/pgadmin4/">pgAdmin4 in Dockerhub</a></li>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html">pgAdmin4 Container Deployment</a></li>
<li><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.udemy.com/course/nestjs-zero-to-hero/">NestJS Zero to Hero Udemy Course</a></li>
</ul></article><div class="w-11/12 max-w-screen-3xl mx-auto lg:w-5/6"><p class="mt-16 text-gray-400">Found an issue with this post?<!-- --> <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/dominicarrojado/dominicarrojado.github.io/issues">Report it here</a>.</p><div class="mt-24 flex justify-between items-center"><a class="group relative pr-2" href="/posts/how-to-create-your-own-swiper-in-react-and-typescript-with-tests-part-2/"><div class=""><div class="font-normal transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">How to create your own swiper, carousel or slider in React and TypeScript with tests (Part 2)</div><small class="text-gray-400 transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Previous Post</small></div><svg viewBox="0 0 320 512" role="img" class="absolute top-0 bottom-0 m-auto shrink-0 w-2 h-2 text-black opacity-30 dark:text-white transform transition-transform-opacity duration-300 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 md:w-3 md:h-3 xl:w-3.5 xl:h-3.5 -left-5 sm:-left-7 xl:-left-8 group-hover:-translate-x-1.5"><path fill="currentColor" d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"></path></svg></a><div></div><a class="group relative pl-2" href="/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1/"><div class="text-right"><div class="font-normal transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1)</div><small class="text-gray-400 transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Next Post</small></div><svg viewBox="0 0 320 512" role="img" class="absolute top-0 bottom-0 m-auto shrink-0 w-2 h-2 text-black opacity-30 dark:text-white transform transition-transform-opacity duration-300 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 md:w-3 md:h-3 xl:w-3.5 xl:h-3.5 -right-5 sm:-right-7 xl:-right-8 group-hover:translate-x-1.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div><div class="mt-16 text-center"><a class="group inline-flex items-center font-normal select-none dark:hover:text-white transition-colors duration-300 hover:text-black group-hover:text-black motion-reduce:transition-none" href="/posts/">See Latest Posts<svg viewBox="0 0 320 512" role="img" class="inline-block w-2 h-2 ml-2 text-black opacity-30 dark:text-white transform transition duration-300 group-hover:translate-x-1.5 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 sm:ml-2.5 md:w-3 md:h-3 md:ml-3 xl:w-3.5 xl:h-3.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div></div><div class="w-11/12 max-w-screen-3xl -mb-8 mx-auto pt-8 sm:-mb-10 sm:pt-10 md:-mb-12 md:pt-12 lg:w-5/6"><ins class="adsbygoogle block max-w-[1200px] mx-auto adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="6892691691" data-ad-format="auto" data-full-width-responsive="true" data-testid="ad-unit"></ins></div></section><footer class="py-20 px-6 bg-gray-100 dark:bg-gray-850 overflow-hidden lg:overflow-auto transition-opacity duration-1000 delay-1750 motion-reduce:transition-none opacity-0" data-testid="footer"><ul class="relative text-center overflow-hidden transition-height duration-1000 motion-reduce:transition-none sm:text-lg xl:text-xl" style="height:0"><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none"><blockquote>“<!-- -->If there is no struggle, there is no progress.<!-- -->”</blockquote><p class="mt-1 sm:mt-2">— <!-- -->Frederick Douglass</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>“<!-- -->It&#x27;s okay to figure out murder mysteries, but you shouldn&#x27;t need to figure out code. You should be able to read it.<!-- -->”</blockquote><p class="mt-1 sm:mt-2">— <!-- -->Steve McConnell</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>“<!-- -->If you can&#x27;t explain it simply, you don&#x27;t understand it well enough.<!-- -->”</blockquote><p class="mt-1 sm:mt-2">— <!-- -->Albert Einstein</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>“<!-- -->The secret of getting ahead is getting started.<!-- -->”</blockquote><p class="mt-1 sm:mt-2">— <!-- -->Mark Twain</p></li></ul><ul class="max-w-full mt-10 flex flex-wrap justify-center lg:hidden"><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2050ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-donate" href="https://www.paypal.com/paypalme/DominicArrojado" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Show your support and donate!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M256 416c114.9 0 208-93.1 208-208S370.9 0 256 0 48 93.1 48 208s93.1 208 208 208zM233.8 97.4V80.6c0-9.2 7.4-16.6 16.6-16.6h11.1c9.2 0 16.6 7.4 16.6 16.6v17c15.5.8 30.5 6.1 43 15.4 5.6 4.1 6.2 12.3 1.2 17.1L306 145.6c-3.8 3.7-9.5 3.8-14 1-5.4-3.4-11.4-5.1-17.8-5.1h-38.9c-9 0-16.3 8.2-16.3 18.3 0 8.2 5 15.5 12.1 17.6l62.3 18.7c25.7 7.7 43.7 32.4 43.7 60.1 0 34-26.4 61.5-59.1 62.4v16.8c0 9.2-7.4 16.6-16.6 16.6h-11.1c-9.2 0-16.6-7.4-16.6-16.6v-17c-15.5-.8-30.5-6.1-43-15.4-5.6-4.1-6.2-12.3-1.2-17.1l16.3-15.5c3.8-3.7 9.5-3.8 14-1 5.4 3.4 11.4 5.1 17.8 5.1h38.9c9 0 16.3-8.2 16.3-18.3 0-8.2-5-15.5-12.1-17.6l-62.3-18.7c-25.7-7.7-43.7-32.4-43.7-60.1.1-34 26.4-61.5 59.1-62.4zM480 352h-32.5c-19.6 26-44.6 47.7-73 64h63.8c5.3 0 9.6 3.6 9.6 8v16c0 4.4-4.3 8-9.6 8H73.6c-5.3 0-9.6-3.6-9.6-8v-16c0-4.4 4.3-8 9.6-8h63.8c-28.4-16.3-53.3-38-73-64H32c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h448c17.7 0 32-14.3 32-32v-96c0-17.7-14.3-32-32-32z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2200ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-youtube" href="https://www.youtube.com/channel/UCWwV__qrzg5BYCSwO91Xhxg" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Watch my tech videos!"><svg viewBox="0 0 576 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2350ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-linkedin" href="https://www.linkedin.com/in/dominic-arrojado-75ba03a9/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Let&#x27;s connect on LinkedIn!"><svg viewBox="0 0 448 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2500ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-github" href="https://github.com/dominicarrojado/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Follow me on GitHub!"><svg viewBox="0 0 496 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2650ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-email" href="mailto:dominicarrojado@gmail.com" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Email me!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li></ul><p class="mt-4 text-gray-400 text-sm text-center sm:text-base lg:mt-10 xl:text-lg"><span class="font-normal">©<!-- -->2022<!-- --> Dominic Arrojado</span> <span class="block mt-1 sm:hidden"></span><span class="hidden sm:inline">·</span> <a href="/privacy-policy/">Privacy Policy</a> <!-- -->·<!-- --> <a href="/disclaimer/">Disclaimer</a></p></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"local-development-setup-for-nestjs-projects-with-postgresql","content":"\n## Introduction\n\nThis is a guide on how to setup a local development for [NestJS](https://docs.nestjs.com/) (a progressive [Node.js](https://nodejs.org/en/) framework) projects with [TypeScript](https://www.typescriptlang.org/), [PostgreSQL](https://www.postgresql.org/) and [pgAdmin4](https://www.pgadmin.org/) using [Docker Compose](https://docs.docker.com/compose/). We'll be using [TypeORM](https://typeorm.io/) to connect and talk to our PostgreSQL database. This is your quick way to get started with Nest and it also involves extensions and libraries that helps us save time and energy when writing our code.\n\n## Skip\n\nIf you don't want to go through the steps below and you just want to get the boilerplate to save time, you can [clone it here](https://github.com/dominicarrojado/nestjs-postgres-boilerplate) or run the [git](https://git-scm.com/) command below:\n\n```bash\ngit clone git@github.com:dominicarrojado/nestjs-postgres-boilerplate.git my-app\n```\n\nDon't forget to ⭐ and share the [repo](https://github.com/dominicarrojado/nestjs-postgres-boilerplate) if you like it!\n\n## Prerequisites\n\nUpon writing this post, I assume that you have some server-side application development background and basic knowledge regarding [npm](https://www.npmjs.com/), [yarn](https://classic.yarnpkg.com/lang/en/), [JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript), [TypeScript](https://www.typescriptlang.org/), [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/), [Node.js](https://nodejs.org/en/), [NestJS](https://docs.nestjs.com/), [TypeORM](https://typeorm.io/) and [PostgreSQL](https://www.postgresql.org/).\n\nPlease make sure to install [Yarn](https://classic.yarnpkg.com/lang/en/) and [Docker Desktop](https://www.docker.com/products/docker-desktop/) in your system if you haven't. We use [Yarn](https://classic.yarnpkg.com/lang/en/) as our package manager, it's just like [npm](https://www.npmjs.com/) but _faster_. While we use [Docker](https://www.docker.com/) throughout the development lifecycle for fast, easy and portable application development.\n\nWe'll be using [Visual Studio Code](https://code.visualstudio.com/) as our [IDE](https://en.wikipedia.org/wiki/Integrated_development_environment) in setting this local development setup as we will utilize a few extensions from their [marketplace](https://marketplace.visualstudio.com/vscode).\n\nYou can also use [Postman](https://www.postman.com/) to interact with the API but that's optional as this won't be a full Nest tutorial.\n\n## Initialize your project\n\nSetting up a new project is quite simple with the [Nest CLI](https://docs.nestjs.com/cli/overview). With `yarn` installed, you can create a new Nest project with the following commands in your OS terminal:\n\n```bash\nyarn global add @nestjs/cli\nnest new my-app\n```\n\nChoose `yarn` as the package manager.\n\nOnce installed, let's run our project to see if everything is working fine by executing the command below:\n\n```bash\ncd my-app\nyarn start\n```\n\nOnce the application is running, open your browser and go to `http://localhost:3000/`. You should see a `Hello World!` message.\n\nTo watch for changes in your files, you can run the following command instead to start the application:\n\n```bash\nyarn start:dev\n```\n\nThis command will watch your files, when you have changes, it will automatically start recompiling and reloading the server. That's great for local development!\n\nTo build and run our Nest application for production, you can simply run the following command:\n\n```bash\nyarn build\nyarn start:prod\n```\n\n---\n\n## Install extensions in Visual Studio Code\n\nOpen the created project in your Visual Studio Code. Let's install [Prettier](https://prettier.io/), it's a code formatter that formats the code for us when we save file changes which is a time-saver.\n\nClick on the \"Extensions\" tab and look for \"Prettier\" and install it. You can also install it via this [link](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode).\n\n![Screenshot of how to install Prettier extension in Visual Studio Code](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/install-prettier-extension-in-visual-studio-code.png)\n\nAfter Prettier is installed, we still need to enable the formatting feature by updating our settings in Visual Studio Code. Let's create a folder in the root directory and name it `.vscode`. Then, create a file inside it and name it `settings.json`. Then update the created file with the code below:\n\n```json\n{\n  \"editor.formatOnSave\": true,\n  \"editor.defaultFormatter\": \"esbenp.prettier-vscode\",\n  \"editor.tabSize\": 2\n}\n```\n\nFeel free to modify `editor.tabSize` as that can be changed according to your preference.\n\nWhen we created a new Nest project, it already includes `.prettierrc` which is the config for Prettier to follow when formatting the code. These configs can be updated according to your preference.\n\nAlright, once the changes are done. That should make our Prettier work.\n\nYou can also install [ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint) extension in Visual Studio Code to help with the linting checks.\n\n## Dockerfile\n\nA [Dockerfile](https://docs.docker.com/engine/reference/builder/) is text document that contains the instructions for Docker to assemble or build an image.\n\nLet's create a `Dockerfile` in the root folder of our application and add the following code below:\n\n```dockerfile\n# syntax=docker/dockerfile:1\n\nFROM node:16.14.2-alpine\nENV NODE_ENV=production\n\nWORKDIR /app\n\nCOPY [ \"package.json\", \"yarn.lock*\", \"./\" ]\n\nRUN yarn install --frozen-lockfile --production\n\nCOPY . .\n\nRUN yarn global add @nestjs/cli\nRUN yarn build\n\nCMD [ \"yarn\", \"start:prod\" ]\n```\n\nIf you're new to Docker or you need an explanation of what each line does, you can refer to the [section here](https://docs.docker.com/language/nodejs/build-images/#create-a-dockerfile-for-nodejs) from [Docker Documentation](https://docs.docker.com/), they explained it really well on while walking you through the process of creating a Dockerfile for Node.js. The `Dockerfile` we have created here is based from their example.\n\nNext, let's create a `.dockerignore` file in the root folder with the following content:\n\n```\nnode_modules\ndist\n```\n\nFiles or directories added in this file will get excluded in the build context. This will increase the build's performance and improve the context load time.\n\n---\n\n## Build image\n\nNow that we've created our `Dockerfile`, let's build our image. You are able to do this by the `docker build` command. The `docker build` command builds Docker images from a `Dockerfile` and a \"context\". A build's context is the set of files located in the specified PATH or URL. The Docker build process can access any of the files located in the context.\n\nThe build command optionally takes a `--tag` flag. The tag is used to set the name of the image and an optional tag in the format `name:tag`. We'll leave off the optional \"tag\" for now to help simplify things. If you do not pass a tag, Docker will use \"latest\" as its default tag. You'll see this in the last line of the build output.\n\nLet's build our first Docker image. Do remember to start your Docker Desktop application before executing the command below:\n\n```bash\ndocker build --tag nest-docker .\n```\n\n![Screenshot of docker build result](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/docker-build-result.png)\n\nIf you open your Docker Desktop, you'll see our `nest-docker` image in the \"Images\" tab.\n\n![Screenshot of Docker Desktop images](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/docker-desktop-images.png)\n\n## Run our image as a container\n\nNow that we have an image, we can run that image and see if our application is running correctly.\n\nA container is a normal operating system process except that this process is isolated and has its own file system, its own networking, and its own isolated process tree separate from the host.\n\nTo run an image inside of a container, we use the `docker run` command. Let's start our image and make sure it is running correctly. Execute the following command in your terminal.\n\n```bash\ndocker run --detach --publish 3000:3000 nest-docker\n```\n\nWe have 2 parameters in this command, that's `--detach` and `--publish 3000:3000`. So remember that contianers runs in isolation, hence we are not able to connect to it unless we publish it. To publish a port for our container, we used the `--publish` flag (-p for short) on the docker run command. The format of the `--publish` command is `[host port]:[container port]`. We can then access our application running in the `container port` via the `host port`. While `--detach` basically runs our container in detached mode or in the background so that our terminal (which where we ran the command) will not have it connected.\n\n![Screenshot of Docker Desktop containers](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/docker-desktop-containers.png)\n\nNow that the application is running, open your browser and go to `http://localhost:3000/`. You should see the same `Hello World!` message.\n\nNow we have successfully containerized our application.\n\n---\n\n## Multi-stage builds\n\nCurrently, we only containerized our application for **production**. But how about for (local) **development**? [Multi-stage builds](https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds) is the way to go. With multi-stage builds, we can use multiple `FROM` statements in our Dockerfile. Each `FROM` instruction can use a different base, and each of them begins a new stage of the build.\n\nLet's update our `Dockerfile` with the following code:\n\n```dockerfile\n# syntax=docker/dockerfile:1\n\nFROM node:16.14.2-alpine AS base\n\nWORKDIR /app\n\nCOPY [ \"package.json\", \"yarn.lock*\", \"./\" ]\n\nFROM base AS dev\nENV NODE_ENV=development\nRUN yarn install --frozen-lockfile\nCOPY . .\nCMD [ \"yarn\", \"start:dev\" ]\n\nFROM base AS prod\nENV NODE_ENV=production\nRUN yarn install --frozen-lockfile --production\nCOPY . .\nRUN yarn global add @nestjs/cli\nRUN yarn build\nCMD [ \"yarn\", \"start:prod\" ]\n```\n\nNow we can build the image with a target using the `docker build` command with a `--target` parameter. Let's use `dev` as our target to build and run our application for local development.\n\n```bash\ndocker build --target dev --tag nest-docker .\ndocker run --detach --publish 3000:3000 nest-docker\n```\n\nThis should run the application properly in `dev` mode.\n\n## Docker Compose\n\nJust using `Dockerfile` for our local development is not productive enough yet. When we make changes to our application, we will need to stop it, rebuild it and run it again. Also later on, we will need to configure the database to connect and use in our application. This whole process can be optimized using [Docker Compose](https://docs.docker.com/compose/). Docker Compose is a tool for defining and running multi-container Docker applications. With Docker Compose, you use a [YAML](https://en.wikipedia.org/wiki/YAML) file to configure your application's services. Then, with a single command, you create and start all the services from your configuration. That sounds great, right?\n\nLet's go ahead and create a `docker-compose.yml` file in the root folder and add the following code:\n\n```yml\nversion: '3.9'\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n      target: dev\n    ports:\n      - 3000:3000\n    volumes:\n      - ./src:/app/src\n```\n\nMost of the keys here should be familiar to you except the `volumes` key. The `volumes` key mounts the project directory (current directory, `./src`) on the host to `/app/src` directory inside the container, allowing you to modify the code on the fly, without having to rebuild the image.\n\nOnce the changes are saved, let's test it out by running the following command:\n\n```bash\ndocker-compose build\ndocker-compose up\n\n# OR\n\ndocker-compose up --build\n```\n\nDo remember to stop the docker image we ran previously via the Docker Desktop as we cannot run two applications on the same port.\n\nNow try making a change within the application code, go to `src/app.service.ts` and a few more `!` to the `Hello World` message. Once you save the changes, it will automatically send the new code to the container and that will trigger the rebuild of the application as it is running via `yarn start:dev` or `nest start --watch`. Awesome!\n\nLet's add this `docker-compose` command in our `package.json` scripts so that we can easily type and remember the command in a shorter form:\n\n```json\n{\n  \"name\": \"my-app\",\n  ...\n  \"scripts\": {\n    ...\n    \"docker-compose:dev\": \"docker-compose up --build\"\n  },\n  ...\n}\n```\n\n---\n\n## PostgreSQL and pgAdmin4\n\nIn this post, we'll use [PostgreSQL](https://www.postgresql.org/) as our database and [pgAdmin4](https://www.pgadmin.org/) for our database admin tool to complete our local development setup.\n\nLet's update our `docker-compose.yml` to include their respective docker images:\n\n```yml\n...\n  app:\n    ...\n    depends_on:\n      - db\n\n  db:\n    image: postgres\n    restart: always\n    ports:\n      - 5432:5432\n    environment:\n      POSTGRES_PASSWORD: postgres\n\n  dbadmin:\n    image: dpage/pgadmin4\n    restart: always\n    ports:\n      - 5050:80\n    environment:\n      PGADMIN_DEFAULT_EMAIL: admin@admin.com\n      PGADMIN_DEFAULT_PASSWORD: pgadmin4\n```\n\nPostgreSQL image runs on port `5432` by default and we are just exposing the same port for our application to connect to. The only environment variable required is `POSTGRES_PASSWORD`, the rest are optional or will use the default values. Hence, we have defined a password here. You can read more about the other environment variables for PostgreSQL [here](https://hub.docker.com/_/postgres). The default value for `POSTGRES_USERNAME` and `POSTGRES_DATABASE` would be `postgres`.\n\nOn the other hand, pgAdmin4 image runs on port `80` by default and we are making it accessible outside the container on port `5050`. There are two environment variables required: `PGADMIN_DEFAULT_EMAIL` and `PGADMIN_DEFAULT_PASSWORD`. You can read more about the other environment variables for pgAdmin4 [here](https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html).\n\nWe can control the order of service startup and shutdown with the `depends_on` option. Hence we have added `db` as a dependency for our `app` service.\n\nLet's build and run our Docker Compose and everything should be working fine:\n\n```bash\nyarn docker-compose:dev\n```\n\nOnce all the environments are up and running, open your browser and go to `http://localhost:5050/`. You will be redirected to log in to pgAdmin4. Type in the default email and password we have provided in the `docker-compose.yml`.\n\n![Screenshot of log in to pgAdmin4](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/pgadmin4-log-in.png)\n\nAfter successfully logging in, do a right-click on the \"Servers\" located at the left-hand side of the portal then click \"Register - Server\". It will open up a modal, under the \"General\" tab, give the server a name (e.g. \"Nest Docker\"). Then, go to the \"Connection\" tab and input the following:\n\n![Screenshot of register server in pgAdmin4](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/pgadmin4-register-server.png)\n\nHit \"Save\" and if there was no error means that our pgAdmin4 was able to connect to our PostgreSQL database successfully. The \"Nest Docker\" would be added under the \"Servers\", and you can go through that to see and interact with the database. Here's how you can go to the tables: `Servers` -\u003e `Nest Docker` -\u003e `postgres` -\u003e `Schemas` -\u003e `public` -\u003e `Tables`.\n\n---\n\n## TypeORM\n\nLet's continue and set up a database connection to our Nest application. We'll be using [TypeORM](https://typeorm.io/) which is an [ORM](https://en.wikipedia.org/wiki/Object-relational_mapping) that can help us develop any kind of application that uses databases in a JavaScript or TypeScript friendly way to communicate to the database rather than sending plain queries directly. It also handles a lot of things automatically such as database handling, data types, relations, etc. It also has database abstraction and they support a number of databases, that means we're not tied to a specific database, we can use PostgreSQL now and maybe use [MongoDB](https://www.mongodb.com/) tomorrow by just changing the configuration when initializing TypeORM and minor changes to the shape of your entities.\n\nTo use TypeORM in Nest. First, install the following dependencies:\n\n```bash\nyarn add @nestjs/typeorm typeorm@0.2 pg\n```\n\n\u003e Note that we're using TypeORM v0.2, which isn't the latest version of TypeORM. The latter has substantial modifications and duplicate methods which are used on this post. You can read about typeorm@0.3.0 changes [on their repository](https://github.com/typeorm/typeorm/releases/tag/0.3.0).\n\nWhen installing `typeorm@0.2`, you might need to move `@types/node` from `devDependencies` to `dependencies` as a workaround for [this error](https://github.com/typeorm/typeorm/issues/8951).\n\n```bash\nyarn remove @types/node\nyarn add @types/node\n```\n\nOnce the installation process is complete, we can import the `TypeOrmModule` into the root `AppModule` in `src/app.module.ts` and configure the database connection:\n\n```ts\n...\nimport { TypeOrmModule } from '@nestjs/typeorm';\n\n@Module({\n  imports: [\n    TypeOrmModule.forRoot({\n      type: 'postgres',\n      host: 'db',\n      port: 5432,\n      username: 'postgres',\n      password: 'postgres',\n      database: 'postgres',\n      autoLoadEntities: true,\n      synchronize: true,\n    }),\n  ],\n  ...\n})\nexport class AppModule {}\n```\n\nOnce you save the changes and run our application again, it should be all \"green\" in the terminal logs and that means the connection of the Nest application to our database is successful. Let's verify this by creating a `Users` module along with the controller and service using Nest CLI.\n\n```bash\nnest g module users\nnest g controller users --no-spec\nnest g service users --no-spec\n```\n\n---\n\nNext, we need to create an entity for `User`. In TypeORM, an entity is a class that maps to a database table (or collection when using MongoDB). Create a file `src/users/user.entity.ts` and add the following code:\n\n```ts\nimport { Column, Entity, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class User {\n  @PrimaryGeneratedColumn()\n  id: number;\n\n  @Column()\n  firstName: string;\n\n  @Column()\n  lastName: string;\n\n  @Column({ default: true })\n  isActive: boolean;\n}\n```\n\nTypeORM supports the **repository design pattern**, so each entity has its own repository. These repositories can be obtained from the database connection.\n\nTo begin using the `User` entity, we need to let TypeORM know about it by inserting it into the array in the module `forFeature()` method argument and import it in the users module `src/users/users.module.ts`:\n\n```ts\n...\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { User } from './user.entity';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([User])],\n  ...\n})\nexport class UsersModule {}\n```\n\nThe user module uses the `forFeature()` method to define which repositories are registered in the current scope. With that in place, we can inject the `UsersRepository` into the `UsersService` using the `@InjectRepository()` decorator in `src/users/users.service.ts`:\n\n```ts\nimport { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { User } from './user.entity';\n\n@Injectable()\nexport class UsersService {\n  constructor(\n    @InjectRepository(User) private usersRepository: Repository\u003cUser\u003e\n  ) {}\n\n  getAllUsers(): Promise\u003cArray\u003cUser\u003e\u003e {\n    return this.usersRepository.find({});\n  }\n}\n```\n\nNow to expose a `GET` request handler in our application to get all the users, let's update our users controller `src/users/users.controller.ts`:\n\n```ts\nimport { Controller, Get } from '@nestjs/common';\nimport { User } from './user.entity';\nimport { UsersService } from './users.service';\n\n@Controller('users')\nexport class UsersController {\n  constructor(private usersService: UsersService) {}\n\n  @Get()\n  getAllUsers(): Promise\u003cArray\u003cUser\u003e\u003e {\n    return this.usersService.getAllUsers();\n  }\n}\n```\n\nYou can open your Postman API client (or simply open your browser) and do a `GET` request to `http://localhost:3000/users`.\n\nIt should return a status of `200 OK` and return you an empty array `[]`.\n\nIf you still don't trust it, create a new row in our `user` table using pgAdmin4.\n\n![Screenshot of creating a user row in pgAdmin4](/images/posts/local-development-setup-for-nestjs-projects-with-postgresql/pgadmin4-create-user-row.png)\n\nAnd if you repeat the same `GET` request, it should now return you an array with the user object:\n\n```json\n[{ \"id\": 1, \"firstName\": \"Dominic\", \"lastName\": \"Arrojado\", \"isActive\": true }]\n```\n\n---\n\n## ConfigModule\n\nThere's another thing we need to do, so remember the values we used in initializing `TypeOrmModule`, passing configuration settings such as `host`, `port`, `username`, etc. Applications often run in different environments. Depending on the environment, different configuration settings should be used. Best practice is to store configuration variables in the environment.\n\nIn Node.js applications, it's common to use `.env` files, holding key-value pairs where each key represents a particular value, to represent each environment. Running an app in different environments is then just a matter of swapping in the correct `.env` file.\n\nA good approach for using this technique in Nest is to create a `ConfigModule` that exposes a `ConfigService` which loads the appropriate .env file. While you may choose to write such a module yourself, for convenience Nest provides the `@nestjs/config` package out-of-the box.\n\nTo begin using it, let's install the required dependency:\n\n```bash\nyarn add @nestjs/config cross-env\n```\n\nThen head over to `src/app.module.ts` and import the `ConfigModule` here:\n\n```ts\n...\nimport { ConfigModule, ConfigService } from '@nestjs/config';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      envFilePath: [`stage.${process.env.STAGE}.env`],\n    }),\n    TypeOrmModule.forRootAsync({\n      imports: [ConfigModule],\n      inject: [ConfigService],\n      useFactory: async (configService: ConfigService) =\u003e {\n        return {\n          type: 'postgres',\n          host: configService.get('DB_HOST'),\n          port: configService.get('DB_PORT'),\n          username: configService.get('DB_USERNAME'),\n          password: configService.get('DB_PASSWORD'),\n          database: configService.get('DB_DATABASE'),\n          autoLoadEntities: true,\n          synchronize: true,\n        };\n      },\n    }),\n    UsersModule,\n  ],\n  ...\n})\nexport class AppModule {}\n```\n\nIn order to use the `ConfigModule` when initializing the `TypeOrmModule`, we'll need to switch from using `forRoot` to `forRootAsync` and take advantage of the dependency injection as written above.\n\nWe'll be using `STAGE` from the environment variables as the definition on which `.env` file will be loaded. Go ahead and create `stage.dev.env` and add the following config (you can create a file `stage.prod.env` later when you're ready to deploy your application to production):\n\n```\nPORT=3000\nDB_HOST=db\nDB_PORT=5432\nDB_USERNAME=postgres\nDB_PASSWORD=postgres\nDB_DATABASE=postgres\n```\n\nThen update `package.json` to include `STAGE` environment variable depending on the script:\n\n```json\n{\n  \"name\": \"my-app\",\n  ...\n  \"scripts\": {\n    ...\n    \"start:dev\": \"cross-env STAGE=dev nest start --watch\",\n    \"start:debug\": \"cross-env STAGE=dev nest start --debug --watch\",\n    \"start:prod\": \"cross-env STAGE=prod node dist/main\",\n    ...\n    \"test\": \"cross-env STAGE=dev jest\",\n    \"test:watch\": \"cross-env STAGE=dev jest --watch\",\n    \"test:cov\": \"cross-env STAGE=dev jest --coverage\",\n    ...\n  },\n  ...\n}\n```\n\nHere we are using [`cross-env`](https://github.com/kentcdodds/cross-env) which allows us to have a single command without worrying about setting or using the environment variable properly depending on the platform (e.g. [Windows](https://en.wikipedia.org/wiki/Microsoft_Windows), [MacOS](https://en.wikipedia.org/wiki/MacOS), [Linux](https://en.wikipedia.org/wiki/Linux)).\n\nLet's also update `main.ts` to use the `PORT` from the environment variables:\n\n```ts\nimport { Logger } from '@nestjs/common';\nimport { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app.module';\n\nasync function bootstrap() {\n  const logger = new Logger();\n  const app = await NestFactory.create(AppModule);\n  const port = process.env.PORT;\n\n  await app.listen(port);\n\n  logger.log(`Application listening on port ${port}`);\n}\nbootstrap();\n```\n\nRun the Docker Compose environments again and everything should work fine as before.\n\n---\n\n## Config schema validation\n\nIt is standard practice to throw an exception during application startup if required environment variables haven't been provided or if they don't meet certain validation rules. The `@nestjs/config` package enables two different ways to do this as mentioned [here](https://docs.nestjs.com/techniques/configuration#schema-validation). [Joi](https://github.com/sideway/joi) is one of them which is what we're going to use.\n\nTo use Joi, we must install Joi package:\n\n```bash\nyarn add joi\n```\n\nNext, create the file `src/config.schema.ts` in the root folder with the following content:\n\n```ts\nimport * as Joi from 'joi';\n\nexport const configValidationSchema = Joi.object({\n  STAGE: Joi.string().required(),\n  PORT: Joi.number().default(3000).required(),\n  DB_HOST: Joi.string().required(),\n  DB_PORT: Joi.number().default(5432).required(),\n  DB_USERNAME: Joi.string().required(),\n  DB_PASSWORD: Joi.string().required(),\n  DB_DATABASE: Joi.string().required(),\n});\n```\n\nThen let's make use of this by passing it in the `ConfigModule` option `validationSchema` in `src/app.module.ts`:\n\n```ts\n...\nimport { configValidationSchema } from './config.schema';\n\n@Module({\n  imports: [\n    ConfigModule.forRoot({\n      envFilePath: [`stage.${process.env.STAGE}.env`],\n      validationSchema: configValidationSchema,\n    }),\n    ...\n  ],\n  ...\n})\nexport class AppModule {}\n```\n\nThat's all you need to do. Try removing `DB_USERNAME` in `stage.dev.env` and run the Docker Compose environments. You'll get an error in the end stating: `Error: Config validation error: \"DB_USERNAME\" is required`. That's really helpful for knowing what went wrong while trying to run your application instead of getting a generic error `Unable to connect to the database` if we didn't do the config schema validation otherwise.\n\n---\n\n## Production and test environments\n\nTo finish off our local development setup, we want to be able to run tests using Docker Compose as well.\n\nFirst, let's update the `Dockerfile` to include the 3 scripts that runs the test:\n\n```dockerfile\n...\nCMD [ \"yarn\", \"start:dev\" ]\n\nFROM dev AS test\nENV NODE_ENV=test\nCMD [ \"yarn\", \"test\" ]\n\nFROM test AS test-cov\nCMD [ \"yarn\", \"test:cov\" ]\n\nFROM test AS test-watch\nENV GIT_WORK_TREE=/app GIT_DIR=/app/.git\nRUN apk add git\nCMD [ \"yarn\", \"test:watch\" ]\n\nFROM base AS prod\n...\n```\n\nNote that for `test:watch` to know what has change within the application code, it relies on [git](https://git-scm.com/), so we had some additional instructions for it.\n\nLet's create `production.yml` in the root folder with the following content:\n\n```yml\nservices:\n  app:\n    build:\n      target: prod\n```\n\nIt doesn't contain much as we only want to change the target because this will be appended to the original `docker-compose.yml`.\n\nThen create `test.yml` in the root folder with the following content:\n\n```yml\nservices:\n  app:\n    build:\n      target: test\n```\n\nThen create `test-cov.yml` in the root folder with the following content:\n\n```yml\nservices:\n  app:\n    build:\n      target: test-cov\n    volumes:\n      - ./coverage:/app/coverage\n```\n\nYou should already be familiar with `volumes`. Here, we we are basically syncing the `coverage` folder so that the coverage files generated from the application container will be synced with our current directory. Useful for [`CI/CD`](https://en.wikipedia.org/wiki/CI/CD) where you need to upload the test coverage to a service such as [`codecov`](https://about.codecov.io/).\n\nThen create `test-watch.yml` in the root folder with the following content:\n\n```yml\nservices:\n  app:\n    build:\n      target: test-watch\n    volumes:\n      - .git:/app/.git/\n```\n\nSame as above. Here, we are syncing the `.git` folder from our current directory with the `.git` folder of the application container. That is how it will know what files were changed in the application code and only run the test related to those changes.\n\n---\n\nLet's also move the `dbadmin` service block from `docker-compose.yml` to a new separate file called `dbadmin.yml` as it will only be utilized during `development` but we don't need to that service when we're just running tests.\n\n```yml\nservices:\n  dbadmin:\n    image: dpage/pgadmin4\n    restart: always\n    ports:\n      - 5050:80\n    environment:\n      PGADMIN_DEFAULT_EMAIL: admin@admin.com\n      PGADMIN_DEFAULT_PASSWORD: pgadmin4\n```\n\nThe updated `docker-compose.yml` should look like this now:\n\n```yml\nversion: '3.9'\nservices:\n  app:\n    build:\n      context: .\n      dockerfile: Dockerfile\n      target: dev\n    ports:\n      - 3000:3000\n    volumes:\n      - ./src:/app/src\n    depends_on:\n      - db\n\n  db:\n    image: postgres\n    restart: always\n    ports:\n      - 5432:5432\n    environment:\n      POSTGRES_PASSWORD: postgres\n```\n\nLastly, update the `package.json` to add new scripts and utilize these new Docker Compose targets:\n\n```json\n{\n  \"name\": \"my-app\",\n  ...\n  \"scripts\": {\n    \"test\": \"cross-env STAGE=dev jest --runInBand\",\n    \"test:watch\": \"cross-env STAGE=dev jest --runInBand --watch\",\n    \"test:cov\": \"cross-env STAGE=dev jest --runInBand --coverage\",\n    ...\n    \"docker-compose:dev\": \"docker-compose -f docker-compose.yml -f dbadmin.yml up --build\",\n    \"docker-compose:test\": \"docker-compose -f docker-compose.yml -f test.yml up --build --exit-code-from app\",\n    \"docker-compose:test:cov\": \"docker-compose -f docker-compose.yml -f test-cov.yml up --build --exit-code-from app\",\n    \"docker-compose:test:watch\": \"docker-compose -f docker-compose.yml -f test-watch.yml up --build\",\n    \"docker-compose:prod\": \"docker-compose -f docker-compose.yml -f production.yml -f dbadmin.yml up --build\",\n    \"docker-compose:prod:build-only\": \"docker-compose -f docker-compose.yml -f production.yml build\"\n  },\n  ...\n}\n```\n\nIn the changes, we added `--runInBand` parameter to the scripts `test`, `test:watch` and `test:cov` found in `package.json`. This is done so we can run all tests serially for end-to-end testing that interacts with a database in docker compose, we don't want two or more test cases running in parallel where there's only 1 database as it might affect expected test results.\n\nAlso, with the `-f` option, we are able to use a second configuration file along with the original `docker-compose.yml`. For `docker-compose:test` and `docker-compose:test:cov`, we have a special option `--exit-code-from`, that's because we don't want the services in the Docker Compose to keep running even after completing all the tests, so we should ideally exit from `app`, which is the name of our Nest application container in the `docker-compose.yml`, and stop all the services.\n\n---\n\n## Final words\n\nWell, there you have it! You now have a full-fledged local development setup. Go ahead and start coding your Nest applications from this setup! I hope this was helpful for you, do share this post if you feel that it will be helpful for someone else too. By the way, I did [a post](/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1/) on how to build an application using NestJS framework leveraging on this setup in case you're intestered. Thanks for reading ~\n\n## Online references\n\n- [Nest Documentation](https://docs.nestjs.com/)\n- [Docker Docs](https://docs.docker.com/)\n- [PostgreSQL in Dockerhub](https://hub.docker.com/_/postgres)\n- [pgAdmin4 in Dockerhub](https://hub.docker.com/r/dpage/pgadmin4/)\n- [pgAdmin4 Container Deployment](https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html)\n- [NestJS Zero to Hero Udemy Course](https://www.udemy.com/course/nestjs-zero-to-hero/)\n","previousPost":{"id":"how-to-create-your-own-swiper-in-react-and-typescript-with-tests-part-2","title":"How to create your own swiper, carousel or slider in React and TypeScript with tests (Part 2)","date":"2022-02-11","excerpt":"Learn how to build a modern mobile touch swiper in a reactive and reusable way","category":"technology","videoUrl":"https://youtu.be/V0dfhBc2lj8"},"nextPost":{"id":"building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1","title":"Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1)","date":"2022-05-18","excerpt":"Learn how to build server-side applications in an efficient, reliable and scalable way","category":"technology","videoUrl":"https://youtu.be/c81MhWCuHbI"},"title":"Local development setup for NestJS projects with PostgreSQL","date":"2022-04-15","excerpt":"A quick way to get started with NestJS integrated with TypeScript, PostgreSQL and pgAdmin4 using Docker Compose","category":"technology","videoUrl":"https://youtu.be/pZNE1YMdbio"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"local-development-setup-for-nestjs-projects-with-postgresql"},"buildId":"0s-8t8OVWmO0YFCZwpUwT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
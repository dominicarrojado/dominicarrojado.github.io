<!DOCTYPE html><html lang="en"><head><link rel="preload" href="/fonts/Roboto-Light.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Light.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-LightItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-LightItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Regular.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Italic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Medium.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-MediumItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-MediumItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-Bold.woff" as="font" type="font/woff" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-BoldItalic.woff2" as="font" type="font/woff2" crossorigin="anonymous"/><link rel="preload" href="/fonts/Roboto-BoldItalic.woff" as="font" type="font/woff" crossorigin="anonymous"/><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="theme-color" content="#000000"/><meta name="description" content="Learn how to build server-side applications in an efficient, reliable and scalable way"/><meta name="author" content="Dominic Arrojado"/><link rel="canonical" href="https://dominicarrojado.com/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1/"/><link rel="icon" href="https://dominicarrojado.com/favicon.ico"/><link rel="manifest" href="https://dominicarrojado.com/manifest.json"/><meta property="og:locale" content="en_US"/><meta property="og:type" content="website"/><meta property="og:title" content="Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1) | Dominic Arrojado"/><meta property="og:description" content="Learn how to build server-side applications in an efficient, reliable and scalable way"/><meta property="og:url" content="https://dominicarrojado.com/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1/"/><meta property="og:site_name" content="Dominic Arrojado"/><meta property="og:image" content="https://dominicarrojado.com/images/pages/guides-tips-and-tricks-to-web-development.png"/><meta property="og:image:secure_url" content="https://dominicarrojado.com/images/pages/guides-tips-and-tricks-to-web-development.png"/><meta property="og:image:width" content="2400"/><meta property="og:image:height" content="1254"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:description" content="Learn how to build server-side applications in an efficient, reliable and scalable way"/><meta name="twitter:title" content="Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1) | Dominic Arrojado"/><meta name="twitter:image" content="https://dominicarrojado.com/images/pages/guides-tips-and-tricks-to-web-development.png"/><title>Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1) | Dominic Arrojado</title><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/b0dd681f34c77a9a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b0dd681f34c77a9a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/82d01f71dc75279c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/82d01f71dc75279c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-5cd0c489085f7601.js" defer=""></script><script src="/_next/static/chunks/framework-433e73989db4e225.js" defer=""></script><script src="/_next/static/chunks/main-c51b0b3c89045435.js" defer=""></script><script src="/_next/static/chunks/pages/_app-54ce051741c94070.js" defer=""></script><script src="/_next/static/chunks/216-1077b041778ead2e.js" defer=""></script><script src="/_next/static/chunks/466-2aafae0e90314603.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-b0935d8569e72e92.js" defer=""></script><script src="/_next/static/kLZQeYg71KvpakYRIR0ds/_buildManifest.js" defer=""></script><script src="/_next/static/kLZQeYg71KvpakYRIR0ds/_ssgManifest.js" defer=""></script><script src="/_next/static/kLZQeYg71KvpakYRIR0ds/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><noscript>
            <iframe
              src="https://www.googletagmanager.com/ns.html?id=GTM-TSMLTPT"
              height="0"
              width="0"
              style="display: none; visibility: hidden"
            ></iframe>
          </noscript><div tabindex="-1" class="h-full outline-none"><header><a href="#main" tabindex="0" class="absolute -top-96 -left-96 w-px h-px text-center text-white overflow-hidden -z-50 focus:top-4 focus:inset-x-0 focus:m-auto focus:w-44 focus:h-auto focus:z-50 focus:sm:w-52 focus:xl:w-56">Skip to main content</a><a class="group fixed top-3.5 left-3.5 z-50 flex shadow-3xl border border-white bg-gray-750 bg-opacity-90 p-1.5 transform transition ease-in-out duration-500 hover:shadow-md hover:bg-opacity-100 motion-reduce:transition-none sm:top-4 sm:left-4 md:top-6 md:left-8 md:border-2 xl:left-9 xl:p-2 delay-700 opacity-0 -translate-y-full" aria-label="Dominic Arrojado logo" href="/"><svg viewBox="0 0 25750 29700" role="img" class="w-7 h-7 text-white transition-colors duration-300 sm:w-8 sm:h-8 md:w-10 md:h-10 xl:w-11 xl:h-11"><path fill="currentColor" d="M4850 19266H1025V2039l4600-129c2511 0 4500 735 5970 2206 1470 1470 2206 3423 2206 5854 0 6199-2985 9296-8951 9296zM4086 4719v11751c494 48 1025 72 1599 72 1543 0 2752-558 3624-1679s1310-2688 1310-4705c0-3684-1712-5524-5135-5524-329 0-795 28-1398 85zm17656 21711l-1437-3969h-6721l974-2655h4730l-2242-6854 1518-4167 7010 17645zM17826 435h3307L10351 29313H7044l4243-11322c1982-1513 2973-4055 2973-7627 0-171-4-340-11-506l3577-9423z"></path></svg></a><div class="fixed flex items-end top-3 right-1 z-50 sm:right-2 md:top-6 md:right-4 xl:top-7" data-testid="header-buttons"><button type="button" aria-expanded="false" aria-controls="dialog-menu" aria-haspopup="dialog" class="group flex items-center flex-col min-w-12 pt-3 pb-2 px-2 outline-none md:min-w-15.5 md:px-3 xl:min-w-18.5"><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 duration-1000 opacity-0 translate-x-1/2" style="transition-delay:500ms" data-testid="menu-stack"></div><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 mt-1.5 duration-1000 opacity-0 -translate-x-1/2" style="transition-delay:650ms" data-testid="menu-stack"></div><div class="w-6 h-0.5 bg-gray-400 rounded dark:bg-gray-300 transform transition group-hover:bg-gray-500 group-focus-visible:bg-gray-500 motion-reduce:transition-none dark:group-hover:bg-white dark:group-focus-visible:bg-white md:w-7 md:h-1 xl:w-8 mt-1.5 duration-1000 opacity-0 translate-x-1/2" style="transition-delay:800ms" data-testid="menu-stack"></div><div class="mt-1.5 text-gray-400 text-3xs font-normal uppercase select-none dark:text-gray-300 transform transition-transform-opacity-color group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-gray-100 md:mt-2 md:text-2xs xl:text-xs duration-700 delay-1000 opacity-0 -translate-y-3">Menu</div></button></div><div class="hidden lg:block lg:fixed lg:bottom-3 lg:right-7 lg:z-40" data-testid="header-social"><ul class="max-w-full mt-10 flex flex-wrap justify-center lg:mt-0"><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2050ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-donate" href="https://www.paypal.com/paypalme/DominicArrojado" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Buy me a protein shake!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M256 416c114.9 0 208-93.1 208-208S370.9 0 256 0 48 93.1 48 208s93.1 208 208 208zM233.8 97.4V80.6c0-9.2 7.4-16.6 16.6-16.6h11.1c9.2 0 16.6 7.4 16.6 16.6v17c15.5.8 30.5 6.1 43 15.4 5.6 4.1 6.2 12.3 1.2 17.1L306 145.6c-3.8 3.7-9.5 3.8-14 1-5.4-3.4-11.4-5.1-17.8-5.1h-38.9c-9 0-16.3 8.2-16.3 18.3 0 8.2 5 15.5 12.1 17.6l62.3 18.7c25.7 7.7 43.7 32.4 43.7 60.1 0 34-26.4 61.5-59.1 62.4v16.8c0 9.2-7.4 16.6-16.6 16.6h-11.1c-9.2 0-16.6-7.4-16.6-16.6v-17c-15.5-.8-30.5-6.1-43-15.4-5.6-4.1-6.2-12.3-1.2-17.1l16.3-15.5c3.8-3.7 9.5-3.8 14-1 5.4 3.4 11.4 5.1 17.8 5.1h38.9c9 0 16.3-8.2 16.3-18.3 0-8.2-5-15.5-12.1-17.6l-62.3-18.7c-25.7-7.7-43.7-32.4-43.7-60.1.1-34 26.4-61.5 59.1-62.4zM480 352h-32.5c-19.6 26-44.6 47.7-73 64h63.8c5.3 0 9.6 3.6 9.6 8v16c0 4.4-4.3 8-9.6 8H73.6c-5.3 0-9.6-3.6-9.6-8v-16c0-4.4 4.3-8 9.6-8h63.8c-28.4-16.3-53.3-38-73-64H32c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h448c17.7 0 32-14.3 32-32v-96c0-17.7-14.3-32-32-32z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2200ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-youtube" href="https://www.youtube.com/channel/UCWwV__qrzg5BYCSwO91Xhxg" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Watch my tech videos!"><svg viewBox="0 0 576 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2350ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-linkedin" href="https://www.linkedin.com/in/dominic-arrojado-75ba03a9/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Let&#x27;s connect on LinkedIn!"><svg viewBox="0 0 448 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2500ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-github" href="https://github.com/dominicarrojado/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Follow me on GitHub!"><svg viewBox="0 0 496 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2650ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-email" href="mailto:dominicarrojado@gmail.com" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Email me!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li></ul></div></header><div id="main"></div><section class="relative flex flex-col justify-center bg-gray-550 py-28 px-6 text-center overflow-hidden dark:bg-gray-750 transform transition-transform ease-in-out duration-500 motion-reduce:transition-none sm:px-20 lg:px-32 min-h-96 -translate-y-full" data-testid="container"><div class="absolute top-0 left-0 w-full h-full bg-repeat bg-center invert-[.1] dark:invert-0 motion-safe:animate-slide transition-opacity duration-1250 delay-500 motion-reduce:transition-none opacity-0" style="background-image:url(&#x27;/images/bg/pattern.png&#x27;)" data-testid="background"></div><div class="overflow-hidden py-2" style="opacity:1"><h1 class="text-3xl font-bold text-white leading-tight transform transition duration-1000 delay-500 motion-reduce:transition-none sm:text-4xl md:text-5xl lg:text-6xl xl:text-7xl opacity-0 translate-y-full">Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1)</h1></div><div class="overflow-hidden" style="opacity:1"><p class="font-light text-white transform transition duration-1000 delay-1000 motion-reduce:transition-none xl:text-2xl opacity-0 translate-y-full">Learn how to build server-side applications in an efficient, reliable and scalable way</p></div></section><section class="pt-16 pb-20 px-6 sm:pt-20 sm:pb-24 sm:px-8 md:pt-24 md:pb-28 lg:px-10 xl:pt-28 xl:pb-32 transform transition-transform-opacity duration-1000 motion-reduce:transition-none delay-1500 opacity-0 translate-y-10" data-testid="section"><div class="-mt-8 w-11/12 max-w-screen-3xl mx-auto pb-8 sm:-mt-10 sm:pb-10 md:-mt-12 md:pb-12 lg:w-5/6"><ins class="adsbygoogle block adUnit_adunit__Qsm4B" data-ad-client="ca-pub-3632473845121107" data-ad-slot="4984498713" data-ad-format="auto" data-full-width-responsive="true"></ins></div><div class="flex justify-between items-center w-11/12 max-w-screen-3xl mx-auto lg:w-5/6"><div class="mr-4 text-sm text-gray-400 sm:text-base xl:text-lg">Last Updated: <time dateTime="2022-05-18">May 18, 2022</time></div><div class="rounded py-0.5 px-1.5 bg-gray-200 text-2xs capitalize dark:bg-gray-600 md:py-1 md:px-2 md:text-xs xl:text-sm">technology</div></div><div class="w-11/12 max-w-screen-3xl mt-4 mx-auto lg:w-5/6"><a class="group inline-flex items-center font-normal select-none dark:hover:text-white transition-colors duration-300 hover:text-black group-hover:text-black motion-reduce:transition-none" target="_blank" rel="noopener noreferrer nofollow" href="https://youtu.be/c81MhWCuHbI"><svg viewBox="0 0 576 512" role="img" class="w-6 h-6 mr-2 text-gray-400 transition-colors duration-300 group-hover:text-red motion-reduce:transition-none dark:group-hover:text-white sm:w-7 sm:h-7 sm:mr-3 xl:w-8 xl:h-8"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg> <!-- -->Watch it on YouTube<svg viewBox="0 0 320 512" role="img" class="inline-block w-2 h-2 ml-2 text-black opacity-30 dark:text-white transform transition duration-300 group-hover:translate-x-1.5 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 sm:ml-2.5 md:w-3 md:h-3 md:ml-3 xl:w-3.5 xl:h-3.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div><article class="w-11/12 max-w-screen-3xl mx-auto prose dark:prose-dark sm:prose-lg lg:w-5/6 xl:prose-xl mt-8 sm:mt-10 xl:mt-14" data-clarity-region="article" data-testid="content"><h2>Introduction</h2>
<p>I started a server-side application late of 2020 which was my way of sharpening my back-end development skills on the side as I have been focused more on the front-end development in my recent jobs. It was built using <a target="_blank" rel="noopener noreferrer nofollow" href="https://expressjs.com/">Express.js</a> which is a fast, unopinionated, minimalist web framework for <a target="_blank" rel="noopener noreferrer nofollow" href="https://nodejs.org/en/">Node.js</a>. But becuase of its unopinionated nature, there were a couple of things I had to set up and configure on my own such as <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.typescriptlang.org/">TypeScript</a>. Although that might be a benefit for most cases, there&#x27;s definitely some pitfalls as well such as not knowing what are some of the best practices when it comes to building server-side applications. You have to do your research and keep yourself up-to-date. The difficulties of those I&#x27;ve mentioned became more obvious when I chance upon myself with <a target="_blank" rel="noopener noreferrer nofollow" href="https://nestjs.com/">NestJS</a>, it is a progressive Node.js framework for building efficient, reliable and scalable server-side applications. NestJS is in fact built on top of Express. I took up a course to learn more about NestJS and how to build applications on top of it and I really liked it. It is extensible, versatile and progressive. It takes advantage of the latest JavaScript features, bringing design patterns and mature solutions to the Node.js world. I can&#x27;t help but think how my server-side application could have been better in many ways if I built it using NestJS from the start. I wanted to improve my skills in NestJS by building something I have not done before, and that is a <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/URL">URL</a> shortener application. That is what I&#x27;m going to share with you in this post, so let&#x27;s go ahead and start learning and building it together!</p>
<h2>Prerequisites</h2>
<p>Upon writing this post, I assume that you have some server-side application development background and basic knowledge regarding <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.npmjs.com/">npm</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">yarn</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript">JavaScript</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.typescriptlang.org/">TypeScript</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/">Docker</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.docker.com/compose/">Docker Compose</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://nodejs.org/en/">Node.js</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/">NestJS</a>, <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/">TypeORM</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postgresql.org/">PostgreSQL</a>.</p>
<p>Please make sure to install <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">Yarn</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/products/docker-desktop/">Docker Desktop</a> in your system if you haven&#x27;t. We use <a target="_blank" rel="noopener noreferrer nofollow" href="https://classic.yarnpkg.com/lang/en/">Yarn</a> as our package manager, it&#x27;s just like <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.npmjs.com/">npm</a> but <em>faster</em>. While we use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.docker.com/">Docker</a> throughout the development lifecycle for fast, easy and portable application development.</p>
<p>We&#x27;ll be using <a target="_blank" rel="noopener noreferrer nofollow" href="https://code.visualstudio.com/">Visual Studio Code</a> as our <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Integrated_development_environment">IDE</a> for building the application as we will utilize a few extensions from their <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/vscode">marketplace</a>.</p>
<p>We&#x27;ll also use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postman.com/">Postman</a> to interact with the API.</p>
<h2>Initialize your project</h2>
<p>To start, you would need to setup your local development for NestJS projects with PostgreSQL, I&#x27;ve written a <a href="/posts/local-development-setup-for-nestjs-projects-with-postgresql/">separate post</a> if you would like to know the details of that setup, but you can also choose to skip that and just clone the <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/dominicarrojado/nestjs-postgres-boilerplate">boilerplate</a> to save time:</p>
<pre><code class="hljs language-bash">git <span class="hljs-built_in">clone</span> git@github.com:dominicarrojado/nestjs-postgres-boilerplate.git url-shortener
</code></pre>
<p>We&#x27;ll be utilizing the Nest CLI commands throughout this post so do install the npm package of it as well.</p>
<pre><code class="hljs language-bash">yarn global add @nestjs/cli
</code></pre>
<p>Once cloned, let&#x27;s open the project in Visual Studio Code. You can install <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode">Prettier</a> and <a target="_blank" rel="noopener noreferrer nofollow" href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint">ESLint</a> extensions in Visual Studio Code if you haven&#x27;t to help with code formatting and linting checks.</p>
<p>Then, open the terminal in Visual Studio Code. The keyboard shortcut would be <code>Ctrl</code> + <code>`</code>.</p>
<p>Next, type the following below in your terminal to install the npm packages or dependencies of the boilerplate:</p>
<pre><code class="hljs language-bash">yarn install --frozen-lockfile
</code></pre>
<p>Once dependencies are installed and your Docker Desktop application is running in the background, let&#x27;s run our project to see if everything is working fine by executing the terminal command below:</p>
<pre><code class="hljs language-bash">yarn docker-compose:dev
</code></pre>
<p>It might take some time especially the first time you build the application as it will do a fresh install of all the dependencies in an isolated environment using Docker Compose. Once the application is running, open your browser and go to <code>http://localhost:3000/</code>. You should see the <code>Hello World!</code> message.</p>
<p>This command will run the application in Docker Compose environment while watching your files, when you have changes, it will automatically start recompiling and reloading the application server. That&#x27;s great for local development!</p>
<h2>Clean up the project</h2>
<p>Now, let&#x27;s clean up our project which was created by Nest CLI and the boilerplate. Delete the following files below as we won&#x27;t be needing them:</p>
<ul>
<li>src/app.controller.ts</li>
<li>src/app.controller.spec.ts</li>
<li>src/app.service.ts</li>
<li>src/users/</li>
<li>test/</li>
</ul>
<p>Now go to <code>src/app.module.ts</code> and update the file to remove the imports for <code>AppController</code>, <code>AppService</code> and <code>UsersModule</code> which we have just deleted:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Module } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { ConfigModule, ConfigService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/config&#x27;</span>;
<span class="hljs-keyword">import</span> { TypeOrmModule } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { configValidationSchema } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config.schema&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  ...
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppModule</span> </span>{}
</code></pre>
<h2>Create LinksModule</h2>
<p>Since we&#x27;re going to be working with links for our URL shortener API, we need a module for it. A (feature) module in Nest simply organizes code relevant for a specific feature, keeping code organized and establishing clear boundaries. This helps us manage complexity and develop with <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/SOLID">SOLID</a> principles, especially as the size of the application and/or team grow.</p>
<p>In Nest, modules are singletons by default, and thus you can share the same instance of any provider between multiple modules effortlessly. That&#x27;s awesome because we can share features between modules without duplicating the code in another module.</p>
<p>To create a module for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:</p>
<pre><code class="hljs language-bash">nest g module links
</code></pre>
<p>This command will create a file <code>src/links/links.module.ts</code> and the new module gets imported in our main app module by updating <code>src/app.module.ts</code> for us.</p>
<h2>Create LinksController</h2>
<p>Controllers are responsible for handling incoming requests and returning responses to the client.</p>
<p>To create a controller for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:</p>
<pre><code class="hljs language-bash">nest g controller links --no-spec
</code></pre>
<p>This command will create a file <code>src/links/links.controller.ts</code> and the new controller gets imported in our links module by updating <code>src/links/links.module.ts</code>.</p>
<p>A command parameter <code>--no-spec</code> was added to prevent Nest CLI default behaviour of creating a <code>spec</code> file which where we write tests for our controller. Although we are going to write tests for it later, we don&#x27;t need it at the moment.</p>
<h2>Create LinksService</h2>
<p>Services are responsible for business logics, such as data storage and retrieval, and is designed to be used by a controller. Service is a good candidate to be defined as a provider.</p>
<p>But what is a provider? From Nest documentation, providers are a fundamental concept in Nest. Many of the basic Nest classes may be treated as a provider â€“ services, repositories, factories, helpers, and so on. The main idea of a provider is that it can be injected as dependency; this means objects can create various relationships with each other, and the function of &quot;wiring up&quot; instances of objects can largely be delegated to the Nest runtime system.</p>
<p>To create a service for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:</p>
<pre><code class="hljs language-bash">nest g service links --no-spec
</code></pre>
<p>This command will create a file <code>src/links/links.service.ts</code> and the new controller gets imported in our links module by updating <code>src/links/links.module.ts</code>.</p>
<h2>TypeORM</h2>
<p>We&#x27;ll be using <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/">TypeORM</a> which is an <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> that can help us develop any kind of application that uses databases in a JavaScript or TypeScript friendly way to communicate to the database rather than sending plain queries directly. It also handles a lot of things automatically such as database handling, data types, relations, etc. It also has database abstraction and they support a number of databases, that means we&#x27;re not tied to a specific database, we can use PostgreSQL today and maybe use <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.mongodb.com/">MongoDB</a> tomorrow by just changing the configuration when initializing TypeORM.</p>
<p>This local development setup for NestJS that we&#x27;re using already has TypeORM set up, we don&#x27;t have to do anything extra.</p>
<h2>Create Link entity</h2>
<p>Before we start interacting with the database using TypeORM. We&#x27;ll need to create an entity for our links. Entity is a class that maps to a database table (or collection when using MongoDB). Entity will help us maintain the shape of our links in the database in the form of code that&#x27;s easy to maintain.</p>
<p>Let&#x27;s go ahead and create a file <code>src/links/link.entity.ts</code>. It is important to follow the convention <code>.entity.ts</code> as part of the file name because that&#x27;s how TypeORM with a configuration of <code>autoLoadEntities</code> set as <code>true</code> will know how to auto load them.</p>
<p>You can create an entity by defining a new class and mark it with a decorator <code>@Entity()</code>. Nest is built around a language feature called decorators. Decorators are a well-known concept in a lot of commonly used programming languages, but in the JavaScript world, they&#x27;re still relatively new. In order to better understand how decorators work, Nest documentation recommends reading <a target="_blank" rel="noopener noreferrer nofollow" href="https://medium.com/google-developers/exploring-es7-decorators-76ecb65fb841">this article</a>. Here&#x27;s a simple definition:</p>
<blockquote>
<p>An ES2016 decorator is an expression which returns a function and can take a target, name and property descriptor as arguments. You apply it by prefixing the decorator with an <code>@</code> character and placing this at the very top of what you are trying to decorate. Decorators can be defined for either a class, a method or a property.</p>
</blockquote>
<p>Now you have a better understanding of entities and decorators. Let&#x27;s go ahead and update <code>src/links/link.entity.ts</code> with the following code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Column, Entity, PrimaryGeneratedColumn } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typeorm&#x27;</span>;

<span class="hljs-meta">@Entity</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Link</span> </span>{
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>(<span class="hljs-string">&#x27;uuid&#x27;</span>)
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>()
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>Since database tables consist of columns, your entities must consist of columns too. Each entity class property you marked with a decorator <code>@Column()</code> will be mapped to a database table column. A column can accept options such as <code>unique</code> that marks the column as unique column (creates unique constraint). You can see the other options <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/entities#column-options">here</a>. Each entity must have at least one primary column. There are several types of primary columns found <a target="_blank" rel="noopener noreferrer nofollow" href="https://typeorm.io/entities#primary-columns">here</a>. We&#x27;ll be using <code>@PrimaryGeneratedColumn(&#x27;uuid&#x27;)</code> which the value will be automatically generated with uuid. Uuid is a unique string id. You don&#x27;t have to manually assign its value before save - value will be automatically generated.</p>
<h2>Active Record vs. Data Mapper patterns</h2>
<p>In TypeORM you can use both the Active Record and the Data Mapper patterns. Using the Active Record approach, you define all your query methods inside the model itself, and you save, remove, and load objects using model methods. Simply said, the Active Record pattern is an approach to access your database within your models. Using the Data Mapper approach, you define all your query methods in separate classes called &quot;repositories&quot;, and you save, remove, and load objects using repositories. In data mapper your entities are very dumb - they just define their properties and may have some &quot;dummy&quot; methods. Simply said, data mapper is an approach to access your database within repositories instead of models. You can read more about them in detail <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/typeorm/typeorm/blob/master/docs/active-record-data-mapper.md">here</a>.</p>
<p>We&#x27;ll be using the <strong>Data Mapper</strong> approach as it is more cleaner and more organized that way which results in a more maintainable code, which is more effective in larger applications.</p>
<h2>Create LinksRepository</h2>
<p>Since we&#x27;ll be using the Data Mapper approach, we need to create a repository for our links. A repository helps us manage (insert, update, delete, load, etc.) any entity.</p>
<p>Let&#x27;s create a file <code>srcs/links/links.repository.ts</code> and add the following code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { EntityRepository, Repository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { Link } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./link.entity&#x27;</span>;

<span class="hljs-meta">@EntityRepository</span>(Link)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Repository</span>&lt;<span class="hljs-title">Link</span>&gt; </span>{}
</code></pre>
<p>We now have a repository for our links, to make it available in our links module, go to <code>src/links/links.module.ts</code> and import it:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { LinksRepository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./links.repository&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [TypeOrmModule.forFeature([LinksRepository])],
  ...
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksModule</span> </span>{}
</code></pre>
<h2>Get all links feature</h2>
<p>With our links repository created and available in our links module, we&#x27;re now ready to create our first feature and that is to get all the links from our database.</p>
<p>First, open the file <code>src/links/links.service.ts</code> and update the code with the following:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { InjectRepository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/typeorm&#x27;</span>;
<span class="hljs-keyword">import</span> { Link } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./link.entity&#x27;</span>;
<span class="hljs-keyword">import</span> { LinksRepository } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./links.repository&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  <span class="hljs-attr">linksRepository</span>: LinksRepository;

  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectRepository</span>(LinksRepository) linksRepository: LinksRepository
  </span>)</span> {
    <span class="hljs-built_in">this</span>.linksRepository = linksRepository;
  }

  <span class="hljs-keyword">async</span> getAllLinks(): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">Array</span>&lt;Link&gt;&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksRepository.find({});
  }
}
</code></pre>
<p>Here we did a dependency injection, we injected the links repository into our service via the <code>constructor</code> with the help of the <code>@InjectRepository</code> decorator provided by <code>@nestjs/typeorm</code>. We then use the links repository to make a database call to find all the links and return it. Notice that we have used our <code>Link</code> entity as the return type as well.</p>
<p>We can further shorten the injection of the repository by doing it like this:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectRepository</span>(LinksRepository) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> linksRepository: LinksRepository,
  </span>)</span> {}

  ...
}
</code></pre>
<p>Now go to <code>src/links/links.controller.ts</code> and let&#x27;s import the <code>LinksService</code> like this:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Controller } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { LinksService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./links.service&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;links&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> linksService: LinksService</span>)</span> {}
}
</code></pre>
<p>Now that <code>LinksService</code> is injected into our controller, we can now use it for our <code>GET</code> request. In order to accept incoming <code>GET</code> requests, we can use the <code>Get()</code> decorator provided by Nest.</p>
<p>Let&#x27;s now update <code>src/links/links.controller.ts</code> to accept a <code>GET</code> request from <code>/links</code>, here&#x27;s the code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Controller, Get } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { LinksService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./links.service&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;links&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> linksService: LinksService</span>)</span> {}

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-function"><span class="hljs-title">getAllLinks</span>(<span class="hljs-params"></span>)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.getAllLinks();
  }
}
</code></pre>
<p>That&#x27;s how simple it is in Nest! You can open your Postman API client and do a <code>GET</code> request to <code>http://localhost:3000/links</code>. Remember that your server must be running by executing the command <code>yarn start:dev</code> on your terminal.</p>
<p>It should return a status of <code>200 OK</code> and return you an empty array <code>[]</code> because we didn&#x27;t create any links yet.</p>
<h2>Create a link feature</h2>
<p>The next feature we need to implement now is to be able to create a link. Let&#x27;s create a new function in <code>src/links/links.service.ts</code>:</p>
<pre><code class="hljs language-ts">...

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  createLink(name: <span class="hljs-built_in">string</span>, <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): Link {
    <span class="hljs-keyword">const</span> link = <span class="hljs-built_in">this</span>.linksRepository.create({
      name,
      url,
    });

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.save(link);

    <span class="hljs-keyword">return</span> link;
  }
}
</code></pre>
<p>Now <code>createLink</code> function is ready to be used. Let&#x27;s go and update <code>src/links/links.controller.ts</code> to accept a <code>POST</code> request from <code>/links</code>, here&#x27;s the code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Body, Controller, Get, Post } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  ...

  <span class="hljs-meta">@Post</span>()
  createLink(
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">&#x27;name&#x27;</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>(<span class="hljs-string">&#x27;url&#x27;</span>) url: <span class="hljs-built_in">string</span>,
  ): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.createLink(name, url);
  }
}

</code></pre>
<p><code>@Body</code> is another decorator from Nest which we can use to get a field from the request body or payload.</p>
<p>After saving the changes. Let&#x27;s again open our Postman API client and do a <code>POST</code> request to <code>http://localhost:3000/links</code> with a <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/JSON">JSON</a> object containing <code>name</code> and <code>url</code>.</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;longestintheworld&quot;</span>,
  <span class="hljs-attr">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/&quot;</span>
}
</code></pre>
<p>It should return a status of <code>201 Created</code> and return you with the same JSON object with an <code>id</code>, something like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;longestintheworld&quot;</span>,
  <span class="hljs-attr">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/&quot;</span>,
  <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2541f387-1ff5-4049-b64c-a3afaf440821&quot;</span>
}
</code></pre>
<p>If you do a <code>GET</code> request to <code>http://localhost:3000/links</code>, it should now return an array containing the same JSON object above.</p>
<pre><code class="hljs language-json">[
  {
    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;longestintheworld&quot;</span>,
    <span class="hljs-attr">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/&quot;</span>,
    <span class="hljs-attr">&quot;id&quot;</span>: <span class="hljs-string">&quot;2541f387-1ff5-4049-b64c-a3afaf440821&quot;</span>
  }
]
</code></pre>
<p>Cool! This means everything is working properly as expected.</p>
<p>To keep things simple in the links service and make it easier to write tests later on, let&#x27;s move the code that creates the links as a custom method to our links repository <code>srcs/links/links.repository.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Repository</span>&lt;<span class="hljs-title">Link</span>&gt; </span>{
  <span class="hljs-keyword">async</span> createLink(name: <span class="hljs-built_in">string</span>, <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">const</span> link = <span class="hljs-built_in">this</span>.create({
      name,
      url,
    });

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.save(link);

    <span class="hljs-keyword">return</span> link;
  }
}
</code></pre>
<p>And then update the links service file <code>src/links/links.service.ts</code> like this:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> createLink(name: <span class="hljs-built_in">string</span>, <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksRepository.createLink(name, url);
  }
}
</code></pre>
<p>You can open your Postman API client and do the previous requests we did earlier (use a unique <code>name</code> for every new link) and everything should still work properly as before. Cool! Let&#x27;s continue ~</p>
<h2>Data Transfer Objects (DTO)</h2>
<p>You may have already noticed how many times we had to refer to the properties of a link within our code, in particular, the <code>name</code> and <code>url</code> is passed around from the controller to the service, just to create the link. In the real-world, requirements change and having multiple reference at difference places adds complexity to our application and makes it more difficult to maintain and scale it.</p>
<p>This is how <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Data_transfer_object">Data Transfer Objects (DTO)</a> saves us from this complexity. It is a common concept in software development that is not specific to Nest. Not only it is helpful for encapsulating data between processes but can also be useful for data validations. Do note that DTO is not a model definition but defines the shape of data for a specific process, for example - creating a link.</p>
<p>DTO, similar to model, can defined as classes or interfaces. As per Nest documentation, the recommended approach is to use classes. So let&#x27;s go with that.</p>
<h2>Implement CreateLinkDto</h2>
<p>Now let&#x27;s create the DTO for creating a link. Create a file <code>src/links/dto/create-link.dto.ts</code> and add the following code below:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateLinkDto</span> </span>{
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  url: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>To make use of this DTO, let&#x27;s update our repository <code>src/links/links.repository.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { CreateLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/create-link.dto&#x27;</span>;

<span class="hljs-meta">@EntityRepository</span>(Link)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Repository</span>&lt;<span class="hljs-title">Link</span>&gt; </span>{
  <span class="hljs-keyword">async</span> createLink(createLinkDto: CreateLinkDto): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">const</span> { name, url } = createLinkDto;
    <span class="hljs-keyword">const</span> link = <span class="hljs-built_in">this</span>.create({
      name,
      url,
    });

    ...
  }
}
</code></pre>
<p>Then update our service <code>src/links/links.service.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { CreateLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/create-link.dto&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> createLink(createLinkDto: CreateLinkDto): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksRepository.createLink(createLinkDto);
  }
}
</code></pre>
<p>And lastly update our controller <code>src/links/links.controller.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { CreateLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/create-link.dto&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;links&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  ...

  <span class="hljs-meta">@Post</span>()
  createLink(<span class="hljs-meta">@Body</span>() createLinkDto: CreateLinkDto): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.createLink(createLinkDto);
  }
}
</code></pre>
<p>You can open your Postman API client again and do the previous requests we did earlier (use a unique <code>name</code> for every new link) and everything should still work properly as before. Great!</p>
<h2>Redirect to URL by name feature</h2>
<p>Now let&#x27;s create the feature that makes our application a URL shortener. And that is to redirect to the actual URL by its (short) name, or if we combine with the <a target="_blank" rel="noopener noreferrer nofollow" href="https://en.wikipedia.org/wiki/Domain_name">domain</a>, by its short URL.</p>
<p>Go to <code>src/links/links.service.ts</code> and create a new function:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { FindConditions } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typeorm&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> getLink(conditions: FindConditions&lt;Link&gt;): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksRepository.findOne(conditions);
  }
}
</code></pre>
<p>We defined the type of the argument of our newly created function as <code>FindConditions&lt;Link&gt;</code>, this is so we could reuse the same function later on for when we update a link via its <code>id</code>.</p>
<p>We need to create another module with a controller that can handle the redirection logic. This controller will not have a path name (e.g. <code>/links</code>) so that our URL can be as short as possible. While we can have the a short domain that points to our server, we also don&#x27;t need another level of path (e.g. <code>/links/my-short-url</code>) as part of the generated short URL.</p>
<p>Using what we&#x27;ve learned so far for creating a module and controller, let&#x27;s once again use Nest CLI:</p>
<pre><code class="hljs language-bash">nest g module wildcard
nest g controller wildcard --no-spec
</code></pre>
<p>Let&#x27;s make a minor update to the generated controller <code>src/wildcard/wildcard.controller.ts</code> to remove the path argument from the <code>@Controller</code> decorator:</p>
<pre><code class="hljs language-ts">...

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WildcardController</span> </span>{}
</code></pre>
<p>To use functions from <code>LinksService</code> to other controllers, we need to export it from its module in <code>src/links/links.module.ts</code> like this:</p>
<pre><code class="hljs language-ts">...

<span class="hljs-meta">@Module</span>({
  ...
  <span class="hljs-attr">exports</span>: [LinksService],
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksModule</span> </span>{}
</code></pre>
<p>And then import the <code>LinksModule</code> in <code>src/wildcard/wildcard.module.ts</code> like this:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { LinksModule } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;src/links/links.module&#x27;</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [LinksModule],
  <span class="hljs-attr">controllers</span>: [WildcardController],
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WildcardModule</span> </span>{}
</code></pre>
<p>Finally, let&#x27;s update <code>src/wildcard/wildcard.controller.ts</code> once again to handle the URL shortener logic by using the <code>LinksService</code> function of getting the link by its (short) name:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Controller, Get, Param, Res } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { Response } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;
<span class="hljs-keyword">import</span> { LinksService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;src/links/links.service&#x27;</span>;

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WildcardController</span> </span>{
  <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> linksService: LinksService</span>)</span> {}

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">&#x27;/:name&#x27;</span>)
  <span class="hljs-keyword">async</span> handleRedirect(
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;name&#x27;</span>) name: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Res</span>() res: Response
  ): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksService.getLink({ name });
    <span class="hljs-keyword">return</span> res.redirect(<span class="hljs-number">301</span>, link.url);
  }
}
</code></pre>
<p>Let&#x27;s again open our Postman API client. Do a <code>GET</code> request to <code>http://localhost:3000/longestintheworld</code>, it should return a status of <code>200 OK</code> and return you some HTML code. That means our URL shortener application is doing what it is intended to do. You can also try it on your browser, visit <code>http://localhost:3000/longestintheworld</code>, and you&#x27;ll get redirected to <code>https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/</code>.</p>
<p>You might be wondering why not just use the <code>AppController</code> from earlier? That&#x27;s because if we create the controller there (e.g. <code>Get(&#x27;/:name&#x27;)</code>), it will take precedence against all GET requests from other controllers. For example, a GET request to <code>/links</code> will be routed to the <code>AppController</code> instead of the <code>LinksController</code> which is not ideal. That&#x27;s why we had to create <code>WildcardController</code> instead so that it will be created and handle routes only after other controllers first.</p>
<h2>Delete a link feature</h2>
<p>If we can create links, we should be able to delete them as well. Let&#x27;s go ahead and implement the feature to delete a link. You know the drill, let&#x27;s first create the delete function in the links service <code>src/links/links.service.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> deleteLink(id: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.delete({ id });
  }
}
</code></pre>
<p>After we created the function in the service, we use it in the controller <code>src/links/links.controller.ts</code>:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Body, Controller, Delete, Get, Param, Post } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  ...

  <span class="hljs-meta">@Delete</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>)
  deleteLink(<span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) id: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.deleteLink(id);
  }
}
</code></pre>
<p>You can open your Postman API client, do a <code>DELETE</code> request to <code>http://localhost:3000/links/:id</code>, do replace <code>:id</code> with the <code>id</code> you got from creating a link or from getting all the links. It should return a status of <code>200 OK</code>.</p>
<h2>Implement UpdateLinkDto</h2>
<p>To complete our set of APIs, we should be able to update a link as well. Let&#x27;s first create the DTO for updating a link. Create a file <code>src/links/dto/update-link.dto.ts</code> and add the following code below:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UpdateLinkDto</span> </span>{
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  url: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>Although it&#x27;s the same shape as <code>CreateLinkDto</code> right now, it is still a good idea to separate them per use case so that it is future-proof.</p>
<h2>Update a link feature</h2>
<p>Now we can update the service <code>src/links/links.service.ts</code> to add the feature to update a link:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { UpdateLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/update-link.dto&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> updateLink(id: <span class="hljs-built_in">string</span>, <span class="hljs-attr">updateLinkDto</span>: UpdateLinkDto): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.getLink({ id });
    <span class="hljs-keyword">const</span> { name, url } = updateLinkDto;

    link.name = name;
    link.url = url;

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.save(link);

    <span class="hljs-keyword">return</span> link;
  }
}
</code></pre>
<p>Then update the controller <code>src/links/links.controller.ts</code> to use the function from the service:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  Post,
  Put,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { UpdateLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/update-link.dto&#x27;</span>;
...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  ...

  <span class="hljs-meta">@Put</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>)
  updateLink(
    <span class="hljs-meta">@Param</span>(<span class="hljs-string">&#x27;id&#x27;</span>) id: <span class="hljs-built_in">string</span>,
    <span class="hljs-meta">@Body</span>() updateLinkDto: UpdateLinkDto
  ): Link {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.updateLink(id, updateLinkDto);
  }
}
</code></pre>
<p>You can open your Postman API client, repeat the steps previously for creating a link, remember to get the <code>id</code> as we&#x27;ll need it later. Then do a <code>UPDATE</code> request to <code>http://localhost:3000/links/:id</code>, do replace <code>:id</code> with the <code>id</code> you got from creating a link or from getting all the links, with a JSON object containing <code>name</code> and <code>url</code>:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;shortestintheworld&quot;</span>,
  <span class="hljs-attr">&quot;url&quot;</span>: <span class="hljs-string">&quot;https://u.nu/&quot;</span>
}
</code></pre>
<p>It should return a status of <code>200 OK</code>. When you do a request to get all the links, the updated link should be returned in the response.</p>
<h2>Nest Pipes</h2>
<p>Currently, we don&#x27;t have any validations when creating a link. That is not ideal. Let&#x27;s implement validations and error handling within our application and there&#x27;s a good feature from Nest we can use for such cases and that is <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/pipes#built-in-pipes">Pipes</a>.</p>
<p>Based from Nest documentation, we can say that:</p>
<ul>
<li>Pipes operate on the arguments being processed by a controller route handler, just before the handler is called.</li>
<li>Pipes can perform <strong>data transformation</strong> or <strong>data validation</strong>.</li>
<li>Pipes can return data - either <em>original</em> or <em>modified</em> - which will be passed on to the route handler. Pipes can throw exceptions. Exceptions thrown will be handled by Nest and parsed into an error response.</li>
<li>Pipes can be asynchronous.</li>
<li>You can build your own <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/pipes#custom-pipes">custom pipes</a>.</li>
<li>Pipes can on the parameter-level, handler-level and application level (global).</li>
</ul>
<p>You can read more about pipes and how they operate right <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/pipes">here</a>.</p>
<p>Nest comes with a number of <a target="_blank" rel="noopener noreferrer nofollow" href="https://docs.nestjs.com/pipes#built-in-pipes">built-in-pipes</a> that we can use out-of-the-box. One of them is <code>ValidationPipe</code> which we&#x27;ll be using in a bit.</p>
<h2>Validation when creating and updating a link</h2>
<p>As mentioned above, we need to implement a validation when creating a link. Let&#x27;s first install the following packages that we&#x27;ll be using:</p>
<pre><code class="hljs language-bash">yarn add class-validator class-transformer
</code></pre>
<p><code>class-validator</code> is a really great package that allows use of decorator and non-decorator based validation, you can head over to their <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/typestack/class-validator">GitHub page</a> to learn more. We&#x27;ll be using one of their decorators in our classes to define our validation.</p>
<p>Let&#x27;s go over to <code>src/links/dto/create-link.dto.ts</code> and import one of the decorators from <code>class-validator</code>:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { IsNotEmpty, IsString, IsUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-validator&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateLinkDto</span> </span>{
  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsNotEmpty</span>()
  <span class="hljs-meta">@IsUrl</span>()
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>Don&#x27;t forget to update <code>src/links/dto/update-link.dto.ts</code> with the same changes as well.</p>
<p>From <code>class-validator</code> library, <code>@IsNotEmpty()</code> basically checks if the given value is not empty (<code>!== &#x27;&#x27;</code>, <code>!== null</code>, <code>!== undefined</code>), <code>@IsString()</code> checks if the given value is a string while <code>@IsUrl()</code> checks if the given value is a url.</p>
<p>Our Nest app does not know what to do with these decorators yet until we use the <code>ValidationPipe</code>, we&#x27;ll need to add it in the application level since it is going to be utilized to most of our handlers. Go to <code>src/main.ts</code> and update with the following code:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Logger, ValidationPipe } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
...

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bootstrap</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> logger = <span class="hljs-keyword">new</span> Logger();
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> NestFactory.create(AppModule);
  <span class="hljs-keyword">const</span> port = process.env.PORT;

  app.useGlobalPipes(<span class="hljs-keyword">new</span> ValidationPipe());

  ...
}
bootstrap();
</code></pre>
<p>Alright, let&#x27;s test out the validations. Let&#x27;s open our Postman API client and do a <code>POST</code> request to <code>http://localhost:3000/links</code> without a body. It should return a status of <code>400 Bad Request</code> and return you with a JSON object like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;statusCode&quot;</span>: <span class="hljs-number">400</span>,
  <span class="hljs-attr">&quot;message&quot;</span>: [
    <span class="hljs-string">&quot;name must be a string&quot;</span>,
    <span class="hljs-string">&quot;name should not be empty&quot;</span>,
    <span class="hljs-string">&quot;url must be an URL address&quot;</span>,
    <span class="hljs-string">&quot;url should not be empty&quot;</span>
  ],
  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;Bad Request&quot;</span>
}
</code></pre>
<p>As you can see, it comes with nice and descriptive error messages. This can definitely save us some time rather than us coming up with these messages.</p>
<h2>Error handling if link already exists</h2>
<p>For creating a link, we also need to handle the case where we create a link with a <code>name</code> that already exists in our database. Currently if we created a link twice with the same <code>name</code>, the last request would throw an <code>500 Internal Server Error</code>. Obviously, we don&#x27;t want to show that to our users. If you check the terminal logs from our NestJS app, you should see something like this: <code>ERROR [ExceptionsHandler] duplicate key value violates unique constraint &quot;UQ_519b799f714024e18a740e8cca7&quot;</code>, so basically PostgreSQL has thrown an error and we did not handle it. So to fix that, let&#x27;s update <code>srcs/links/links.repository.ts</code> with the following code:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> {
  ConflictException,
  InternalServerErrorException,
} <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;

<span class="hljs-meta">@EntityRepository</span>(Link)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Repository</span>&lt;<span class="hljs-title">Link</span>&gt; </span>{
  <span class="hljs-keyword">async</span> createLink(createLinkDto: CreateLinkDto): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    ...

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.save(link);
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">if</span> (err.code === <span class="hljs-string">&#x27;23505&#x27;</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ConflictException(<span class="hljs-string">&#x27;Short name already exists&#x27;</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalServerErrorException();
      }
    }

    <span class="hljs-keyword">return</span> link;
  }
}
</code></pre>
<p>So by wrapping the <code>save()</code> function in a <code>try/catch</code> we are able to get the error code from PostgreSQL. Based from <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.postgresql.org/docs/current/errcodes-appendix.html">PostgreSQL documentation</a>, <code>23505</code> is a unique constraint violation. So we have thrown a <code>ConflictException</code> which is from <code>@nestjs/common</code> with a descriptive error message. For any other cases we will throw an <code>InternalServerErrorException</code>, which is the default error for internal server error.</p>
<p>Once you saved the changes and do a <code>POST</code> request to <code>http://localhost:3000/links</code> <strong><em>twice</em></strong> with the same body or payload, it should return a status of <code>409 Conflict</code> and return you with a JSON object like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;statusCode&quot;</span>: <span class="hljs-number">409</span>,
  <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;Short name already exists&quot;</span>,
  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;Conflict&quot;</span>
}
</code></pre>
<h2>Error handling if link does not exist</h2>
<p>For getting, updating or deleting a link, we also need to handle the case where we get a link by an <code>id</code> or a <code>name</code> that does not exist in our database. We can simply do that by updating <code>src/links/links.service.ts</code> with the following:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { Injectable, NotFoundException } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> getLink(conditions: FindConditions&lt;Link&gt;): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.findOne(conditions);

    <span class="hljs-keyword">if</span> (!link) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotFoundException();
    }

    <span class="hljs-keyword">return</span> link;
  }

  ...
}
</code></pre>
<p>Once you saved the changes and do a <code>GET</code> request to <code>http://localhost:3000/doesnotexist</code>, it should return a status of <code>404 Not Found</code> and return you with a JSON object like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;statusCode&quot;</span>: <span class="hljs-number">404</span>,
  <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;Not Found&quot;</span>
}
</code></pre>
<p>So by just from throwing a <code>NotFoundException</code> from Nest, it will bubble up and automatically construct this JSON object for us to return to the client. We didn&#x27;t even had to touch our controller to handle this which is the right way based from what we said earlier about services handling the business logics. Since we are reusing <code>getLink</code> method when updating a link, it will also handle cases where link does not exist.</p>
<p>You can also try updating a link by an <code>id</code> that does not exist and you will get the same response. Do note that if you try to pass an <code>id</code> that&#x27;s not in <code>uuid</code> format, you will still get <code>500 Internal Server Error</code>. To fix that, we can create a new DTO <code>src/links/dto/get-link.dto.ts</code> and add the following code below:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { IsUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;class-validator&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetLinkDto</span> </span>{
  <span class="hljs-meta">@IsUUID</span>()
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>And update our controller <code>src/links/links.controller.ts</code> methods that gets <code>id</code> from the parameters:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { GetLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/get-link.dto&#x27;</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">&#x27;links&#x27;</span>)
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksController</span> </span>{
  ...

  <span class="hljs-meta">@Delete</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>)
  deleteLink(<span class="hljs-meta">@Param</span>() getLinkDto: GetLinkDto): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.deleteLink(getLinkDto);
  }

  <span class="hljs-meta">@Put</span>(<span class="hljs-string">&#x27;/:id&#x27;</span>)
  updateLink(
    <span class="hljs-meta">@Param</span>() getLinkDto: GetLinkDto,
    <span class="hljs-meta">@Body</span>() updateLinkDto: UpdateLinkDto,
  ): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.linksService.updateLink(getLinkDto, updateLinkDto);
  }
}
</code></pre>
<p>And update our service <code>src/links/links.service.ts</code> methods as well:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">import</span> { GetLinkDto } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dto/get-link.dto&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> deleteLink(getLinkDto: GetLinkDto): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> { id } = getLinkDto;
    <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.delete({ id });
  }

  <span class="hljs-keyword">async</span> updateLink(
    getLinkDto: GetLinkDto,
    <span class="hljs-attr">updateLinkDto</span>: UpdateLinkDto,
  ): <span class="hljs-built_in">Promise</span>&lt;Link&gt; {
    <span class="hljs-keyword">const</span> { id } = getLinkDto;
    <span class="hljs-keyword">const</span> link = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.getLink({ id });
    ...
  }
}
</code></pre>
<p>It should now return a <code>400 Bad Request</code> if you pass an <code>id</code> that&#x27;s not in <code>uuid</code> format:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;statusCode&quot;</span>: <span class="hljs-number">400</span>,
  <span class="hljs-attr">&quot;message&quot;</span>: [<span class="hljs-string">&quot;id must be a UUID&quot;</span>],
  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;Bad Request&quot;</span>
}
</code></pre>
<p>Lastly, we should also return a <code>404 Not Found</code> error if we are deleting a link that no longer exists. We can do that by updating the method in <code>src/links/links.service.ts</code>:</p>
<pre><code class="hljs language-ts">...
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinksService</span> </span>{
  ...

  <span class="hljs-keyword">async</span> deleteLink(getLinkDto: GetLinkDto): <span class="hljs-built_in">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">const</span> { id } = getLinkDto;
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.linksRepository.delete({ id });

    <span class="hljs-keyword">if</span> (res.affected === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NotFoundException(<span class="hljs-string">`Link with ID: &quot;<span class="hljs-subst">${id}</span>&quot; not found`</span>);
    }
  }

  ...
}

</code></pre>
<p>As you can see, we can add custom message as an argument for <code>NotFoundException</code> object and we&#x27;ll get an JSON object for the error like this:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">&quot;statusCode&quot;</span>: <span class="hljs-number">404</span>,
  <span class="hljs-attr">&quot;message&quot;</span>: <span class="hljs-string">&quot;Link with ID: \&quot;3232c642-ec07-4e8d-87a2-010cd5c033d2\&quot; not found&quot;</span>,
  <span class="hljs-attr">&quot;error&quot;</span>: <span class="hljs-string">&quot;Not Found&quot;</span>
}
</code></pre>
<p>We&#x27;ve completed the set of APIs for our URL shortener application. It&#x27;s now time to write tests!</p>
<p>Proceed to the <a href="/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-2/">next part</a>.</p></article><div class="w-11/12 max-w-screen-3xl mx-auto lg:w-5/6"><p class="mt-16 text-gray-400">Found an issue with this post?<!-- --> <a target="_blank" rel="noopener noreferrer nofollow" href="https://github.com/dominicarrojado/dominicarrojado.github.io/issues">Report it here</a>.</p><div class="mt-24 flex justify-between items-center"><a class="group relative pr-2" href="/posts/local-development-setup-for-nestjs-projects-with-postgresql/"><div class=""><div class="font-normal transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Local development setup for NestJS projects with PostgreSQL</div><small class="text-gray-400 transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Previous Post</small></div><svg viewBox="0 0 320 512" role="img" class="absolute top-0 bottom-0 m-auto shrink-0 w-2 h-2 text-black opacity-30 dark:text-white transform transition-transform-opacity duration-300 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 md:w-3 md:h-3 xl:w-3.5 xl:h-3.5 -left-5 sm:-left-7 xl:-left-8 group-hover:-translate-x-1.5"><path fill="currentColor" d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"></path></svg></a><div></div><a class="group relative pl-2" href="/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-2/"><div class="text-right"><div class="font-normal transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Building a URL shortener API with NestJS and PostgreSQL with tests (Part 2)</div><small class="text-gray-400 transition-colors duration-300 group-hover:text-black motion-reduce:transition-none dark:group-hover:text-white">Next Post</small></div><svg viewBox="0 0 320 512" role="img" class="absolute top-0 bottom-0 m-auto shrink-0 w-2 h-2 text-black opacity-30 dark:text-white transform transition-transform-opacity duration-300 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 md:w-3 md:h-3 xl:w-3.5 xl:h-3.5 -right-5 sm:-right-7 xl:-right-8 group-hover:translate-x-1.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div><div class="mt-16 text-center"><a class="group inline-flex items-center font-normal select-none dark:hover:text-white transition-colors duration-300 hover:text-black group-hover:text-black motion-reduce:transition-none" href="/posts/">See Latest Posts<svg viewBox="0 0 320 512" role="img" class="inline-block w-2 h-2 ml-2 text-black opacity-30 dark:text-white transform transition duration-300 group-hover:translate-x-1.5 group-hover:opacity-100 motion-reduce:transition-none sm:w-2.5 sm:h-2.5 sm:ml-2.5 md:w-3 md:h-3 md:ml-3 xl:w-3.5 xl:h-3.5"><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg></a></div></div></section><footer class="py-20 px-6 bg-gray-100 dark:bg-gray-850 overflow-hidden lg:overflow-auto transition-opacity duration-1000 delay-1750 motion-reduce:transition-none opacity-0" data-testid="footer"><ul class="relative text-center overflow-hidden transition-height duration-1000 motion-reduce:transition-none sm:text-lg xl:text-xl" style="height:0"><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none"><blockquote>â€œ<!-- -->If there is no struggle, there is no progress.<!-- -->â€</blockquote><p class="mt-1 sm:mt-2">â€” <!-- -->Frederick Douglass</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>â€œ<!-- -->It&#x27;s okay to figure out murder mysteries, but you shouldn&#x27;t need to figure out code. You should be able to read it.<!-- -->â€</blockquote><p class="mt-1 sm:mt-2">â€” <!-- -->Steve McConnell</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>â€œ<!-- -->If you can&#x27;t explain it simply, you don&#x27;t understand it well enough.<!-- -->â€</blockquote><p class="mt-1 sm:mt-2">â€” <!-- -->Albert Einstein</p></li><li class="absolute top-0 left-0 w-full transition-opacity duration-1000 motion-reduce:transition-none opacity-0 pointer-events-none"><blockquote>â€œ<!-- -->The secret of getting ahead is getting started.<!-- -->â€</blockquote><p class="mt-1 sm:mt-2">â€” <!-- -->Mark Twain</p></li></ul><ul class="max-w-full mt-10 flex flex-wrap justify-center lg:hidden"><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2050ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-donate" href="https://www.paypal.com/paypalme/DominicArrojado" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Buy me a protein shake!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M256 416c114.9 0 208-93.1 208-208S370.9 0 256 0 48 93.1 48 208s93.1 208 208 208zM233.8 97.4V80.6c0-9.2 7.4-16.6 16.6-16.6h11.1c9.2 0 16.6 7.4 16.6 16.6v17c15.5.8 30.5 6.1 43 15.4 5.6 4.1 6.2 12.3 1.2 17.1L306 145.6c-3.8 3.7-9.5 3.8-14 1-5.4-3.4-11.4-5.1-17.8-5.1h-38.9c-9 0-16.3 8.2-16.3 18.3 0 8.2 5 15.5 12.1 17.6l62.3 18.7c25.7 7.7 43.7 32.4 43.7 60.1 0 34-26.4 61.5-59.1 62.4v16.8c0 9.2-7.4 16.6-16.6 16.6h-11.1c-9.2 0-16.6-7.4-16.6-16.6v-17c-15.5-.8-30.5-6.1-43-15.4-5.6-4.1-6.2-12.3-1.2-17.1l16.3-15.5c3.8-3.7 9.5-3.8 14-1 5.4 3.4 11.4 5.1 17.8 5.1h38.9c9 0 16.3-8.2 16.3-18.3 0-8.2-5-15.5-12.1-17.6l-62.3-18.7c-25.7-7.7-43.7-32.4-43.7-60.1.1-34 26.4-61.5 59.1-62.4zM480 352h-32.5c-19.6 26-44.6 47.7-73 64h63.8c5.3 0 9.6 3.6 9.6 8v16c0 4.4-4.3 8-9.6 8H73.6c-5.3 0-9.6-3.6-9.6-8v-16c0-4.4 4.3-8 9.6-8h63.8c-28.4-16.3-53.3-38-73-64H32c-17.7 0-32 14.3-32 32v96c0 17.7 14.3 32 32 32h448c17.7 0 32-14.3 32-32v-96c0-17.7-14.3-32-32-32z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2200ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-youtube" href="https://www.youtube.com/channel/UCWwV__qrzg5BYCSwO91Xhxg" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Watch my tech videos!"><svg viewBox="0 0 576 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2350ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-linkedin" href="https://www.linkedin.com/in/dominic-arrojado-75ba03a9/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Let&#x27;s connect on LinkedIn!"><svg viewBox="0 0 448 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2500ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-github" href="https://github.com/dominicarrojado/" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Follow me on GitHub!"><svg viewBox="0 0 496 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="flex lg:transform lg:transition lg:ease-in-out lg:duration-500 motion-reduce:lg:transition-none lg:opacity-0 lg:translate-y-full" style="transition-delay:2650ms"><a target="_blank" rel="noopener noreferrer nofollow" tabindex="0" aria-describedby="tooltip-email" href="mailto:dominicarrojado@gmail.com" class="group inline-flex p-3 cursor-pointer sm:p-4" aria-label="Email me!"><svg viewBox="0 0 512 512" role="img" class="w-7 h-7 text-gray-400 dark:text-gray-300 transition-colors group-hover:text-gray-500 motion-reduce:transition-none dark:group-hover:text-white sm:w-8 sm:h-8 xl:w-9 xl:h-9"><path fill="currentColor" d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"></path></svg></a></li></ul><p class="mt-4 text-gray-400 text-sm text-center sm:text-base lg:mt-10 xl:text-lg"><span class="font-normal">Â©<!-- -->2022<!-- --> Dominic Arrojado</span> <span class="block mt-1 sm:hidden"></span><span class="hidden sm:inline">Â·</span> <a href="/privacy-policy/">Privacy Policy</a> <!-- -->Â·<!-- --> <a href="/disclaimer/">Disclaimer</a></p></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1","content":"\n## Introduction\n\nI started a server-side application late of 2020 which was my way of sharpening my back-end development skills on the side as I have been focused more on the front-end development in my recent jobs. It was built using [Express.js](https://expressjs.com/) which is a fast, unopinionated, minimalist web framework for [Node.js](https://nodejs.org/en/). But becuase of its unopinionated nature, there were a couple of things I had to set up and configure on my own such as [TypeScript](https://www.typescriptlang.org/). Although that might be a benefit for most cases, there's definitely some pitfalls as well such as not knowing what are some of the best practices when it comes to building server-side applications. You have to do your research and keep yourself up-to-date. The difficulties of those I've mentioned became more obvious when I chance upon myself with [NestJS](https://nestjs.com/), it is a progressive Node.js framework for building efficient, reliable and scalable server-side applications. NestJS is in fact built on top of Express. I took up a course to learn more about NestJS and how to build applications on top of it and I really liked it. It is extensible, versatile and progressive. It takes advantage of the latest JavaScript features, bringing design patterns and mature solutions to the Node.js world. I can't help but think how my server-side application could have been better in many ways if I built it using NestJS from the start. I wanted to improve my skills in NestJS by building something I have not done before, and that is a [URL](https://en.wikipedia.org/wiki/URL) shortener application. That is what I'm going to share with you in this post, so let's go ahead and start learning and building it together!\n\n## Prerequisites\n\nUpon writing this post, I assume that you have some server-side application development background and basic knowledge regarding [npm](https://www.npmjs.com/), [yarn](https://classic.yarnpkg.com/lang/en/), [JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript), [TypeScript](https://www.typescriptlang.org/), [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/), [Node.js](https://nodejs.org/en/), [NestJS](https://docs.nestjs.com/), [TypeORM](https://typeorm.io/) and [PostgreSQL](https://www.postgresql.org/).\n\nPlease make sure to install [Yarn](https://classic.yarnpkg.com/lang/en/) and [Docker Desktop](https://www.docker.com/products/docker-desktop/) in your system if you haven't. We use [Yarn](https://classic.yarnpkg.com/lang/en/) as our package manager, it's just like [npm](https://www.npmjs.com/) but _faster_. While we use [Docker](https://www.docker.com/) throughout the development lifecycle for fast, easy and portable application development.\n\nWe'll be using [Visual Studio Code](https://code.visualstudio.com/) as our [IDE](https://en.wikipedia.org/wiki/Integrated_development_environment) for building the application as we will utilize a few extensions from their [marketplace](https://marketplace.visualstudio.com/vscode).\n\nWe'll also use [Postman](https://www.postman.com/) to interact with the API.\n\n## Initialize your project\n\nTo start, you would need to setup your local development for NestJS projects with PostgreSQL, I've written a [separate post](/posts/local-development-setup-for-nestjs-projects-with-postgresql/) if you would like to know the details of that setup, but you can also choose to skip that and just clone the [boilerplate](https://github.com/dominicarrojado/nestjs-postgres-boilerplate) to save time:\n\n```bash\ngit clone git@github.com:dominicarrojado/nestjs-postgres-boilerplate.git url-shortener\n```\n\nWe'll be utilizing the Nest CLI commands throughout this post so do install the npm package of it as well.\n\n```bash\nyarn global add @nestjs/cli\n```\n\nOnce cloned, let's open the project in Visual Studio Code. You can install [Prettier](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode) and [ESLint](https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint) extensions in Visual Studio Code if you haven't to help with code formatting and linting checks.\n\nThen, open the terminal in Visual Studio Code. The keyboard shortcut would be `Ctrl` + `` ` ``.\n\nNext, type the following below in your terminal to install the npm packages or dependencies of the boilerplate:\n\n```bash\nyarn install --frozen-lockfile\n```\n\nOnce dependencies are installed and your Docker Desktop application is running in the background, let's run our project to see if everything is working fine by executing the terminal command below:\n\n```bash\nyarn docker-compose:dev\n```\n\nIt might take some time especially the first time you build the application as it will do a fresh install of all the dependencies in an isolated environment using Docker Compose. Once the application is running, open your browser and go to `http://localhost:3000/`. You should see the `Hello World!` message.\n\nThis command will run the application in Docker Compose environment while watching your files, when you have changes, it will automatically start recompiling and reloading the application server. That's great for local development!\n\n## Clean up the project\n\nNow, let's clean up our project which was created by Nest CLI and the boilerplate. Delete the following files below as we won't be needing them:\n\n- src/app.controller.ts\n- src/app.controller.spec.ts\n- src/app.service.ts\n- src/users/\n- test/\n\nNow go to `src/app.module.ts` and update the file to remove the imports for `AppController`, `AppService` and `UsersModule` which we have just deleted:\n\n```ts\nimport { Module } from '@nestjs/common';\nimport { ConfigModule, ConfigService } from '@nestjs/config';\nimport { TypeOrmModule } from '@nestjs/typeorm';\nimport { configValidationSchema } from './config.schema';\n\n@Module({\n  ...\n  controllers: [],\n  providers: [],\n})\nexport class AppModule {}\n```\n\n## Create LinksModule\n\nSince we're going to be working with links for our URL shortener API, we need a module for it. A (feature) module in Nest simply organizes code relevant for a specific feature, keeping code organized and establishing clear boundaries. This helps us manage complexity and develop with [SOLID](https://en.wikipedia.org/wiki/SOLID) principles, especially as the size of the application and/or team grow.\n\nIn Nest, modules are singletons by default, and thus you can share the same instance of any provider between multiple modules effortlessly. That's awesome because we can share features between modules without duplicating the code in another module.\n\nTo create a module for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:\n\n```bash\nnest g module links\n```\n\nThis command will create a file `src/links/links.module.ts` and the new module gets imported in our main app module by updating `src/app.module.ts` for us.\n\n## Create LinksController\n\nControllers are responsible for handling incoming requests and returning responses to the client.\n\nTo create a controller for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:\n\n```bash\nnest g controller links --no-spec\n```\n\nThis command will create a file `src/links/links.controller.ts` and the new controller gets imported in our links module by updating `src/links/links.module.ts`.\n\nA command parameter `--no-spec` was added to prevent Nest CLI default behaviour of creating a `spec` file which where we write tests for our controller. Although we are going to write tests for it later, we don't need it at the moment.\n\n## Create LinksService\n\nServices are responsible for business logics, such as data storage and retrieval, and is designed to be used by a controller. Service is a good candidate to be defined as a provider.\n\nBut what is a provider? From Nest documentation, providers are a fundamental concept in Nest. Many of the basic Nest classes may be treated as a provider â€“ services, repositories, factories, helpers, and so on. The main idea of a provider is that it can be injected as dependency; this means objects can create various relationships with each other, and the function of \"wiring up\" instances of objects can largely be delegated to the Nest runtime system.\n\nTo create a service for links. In the root folder of our project, you can simply run this Nest CLI command in your OS terminal:\n\n```bash\nnest g service links --no-spec\n```\n\nThis command will create a file `src/links/links.service.ts` and the new controller gets imported in our links module by updating `src/links/links.module.ts`.\n\n## TypeORM\n\nWe'll be using [TypeORM](https://typeorm.io/) which is an [ORM](https://en.wikipedia.org/wiki/Object-relational_mapping) that can help us develop any kind of application that uses databases in a JavaScript or TypeScript friendly way to communicate to the database rather than sending plain queries directly. It also handles a lot of things automatically such as database handling, data types, relations, etc. It also has database abstraction and they support a number of databases, that means we're not tied to a specific database, we can use PostgreSQL today and maybe use [MongoDB](https://www.mongodb.com/) tomorrow by just changing the configuration when initializing TypeORM.\n\nThis local development setup for NestJS that we're using already has TypeORM set up, we don't have to do anything extra.\n\n## Create Link entity\n\nBefore we start interacting with the database using TypeORM. We'll need to create an entity for our links. Entity is a class that maps to a database table (or collection when using MongoDB). Entity will help us maintain the shape of our links in the database in the form of code that's easy to maintain.\n\nLet's go ahead and create a file `src/links/link.entity.ts`. It is important to follow the convention `.entity.ts` as part of the file name because that's how TypeORM with a configuration of `autoLoadEntities` set as `true` will know how to auto load them.\n\nYou can create an entity by defining a new class and mark it with a decorator `@Entity()`. Nest is built around a language feature called decorators. Decorators are a well-known concept in a lot of commonly used programming languages, but in the JavaScript world, they're still relatively new. In order to better understand how decorators work, Nest documentation recommends reading [this article](https://medium.com/google-developers/exploring-es7-decorators-76ecb65fb841). Here's a simple definition:\n\n\u003e An ES2016 decorator is an expression which returns a function and can take a target, name and property descriptor as arguments. You apply it by prefixing the decorator with an `@` character and placing this at the very top of what you are trying to decorate. Decorators can be defined for either a class, a method or a property.\n\nNow you have a better understanding of entities and decorators. Let's go ahead and update `src/links/link.entity.ts` with the following code:\n\n```ts\nimport { Column, Entity, PrimaryGeneratedColumn } from 'typeorm';\n\n@Entity()\nexport class Link {\n  @PrimaryGeneratedColumn('uuid')\n  id: string;\n\n  @Column({ unique: true })\n  name: string;\n\n  @Column()\n  url: string;\n}\n```\n\nSince database tables consist of columns, your entities must consist of columns too. Each entity class property you marked with a decorator `@Column()` will be mapped to a database table column. A column can accept options such as `unique` that marks the column as unique column (creates unique constraint). You can see the other options [here](https://typeorm.io/entities#column-options). Each entity must have at least one primary column. There are several types of primary columns found [here](https://typeorm.io/entities#primary-columns). We'll be using `@PrimaryGeneratedColumn('uuid')` which the value will be automatically generated with uuid. Uuid is a unique string id. You don't have to manually assign its value before save - value will be automatically generated.\n\n## Active Record vs. Data Mapper patterns\n\nIn TypeORM you can use both the Active Record and the Data Mapper patterns. Using the Active Record approach, you define all your query methods inside the model itself, and you save, remove, and load objects using model methods. Simply said, the Active Record pattern is an approach to access your database within your models. Using the Data Mapper approach, you define all your query methods in separate classes called \"repositories\", and you save, remove, and load objects using repositories. In data mapper your entities are very dumb - they just define their properties and may have some \"dummy\" methods. Simply said, data mapper is an approach to access your database within repositories instead of models. You can read more about them in detail [here](https://github.com/typeorm/typeorm/blob/master/docs/active-record-data-mapper.md).\n\nWe'll be using the **Data Mapper** approach as it is more cleaner and more organized that way which results in a more maintainable code, which is more effective in larger applications.\n\n## Create LinksRepository\n\nSince we'll be using the Data Mapper approach, we need to create a repository for our links. A repository helps us manage (insert, update, delete, load, etc.) any entity.\n\nLet's create a file `srcs/links/links.repository.ts` and add the following code:\n\n```ts\nimport { EntityRepository, Repository } from 'typeorm';\nimport { Link } from './link.entity';\n\n@EntityRepository(Link)\nexport class LinksRepository extends Repository\u003cLink\u003e {}\n```\n\nWe now have a repository for our links, to make it available in our links module, go to `src/links/links.module.ts` and import it:\n\n```ts\n...\nimport { LinksRepository } from './links.repository';\n\n@Module({\n  imports: [TypeOrmModule.forFeature([LinksRepository])],\n  ...\n})\nexport class LinksModule {}\n```\n\n## Get all links feature\n\nWith our links repository created and available in our links module, we're now ready to create our first feature and that is to get all the links from our database.\n\nFirst, open the file `src/links/links.service.ts` and update the code with the following:\n\n```ts\nimport { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Link } from './link.entity';\nimport { LinksRepository } from './links.repository';\n\n@Injectable()\nexport class LinksService {\n  linksRepository: LinksRepository;\n\n  constructor(\n    @InjectRepository(LinksRepository) linksRepository: LinksRepository\n  ) {\n    this.linksRepository = linksRepository;\n  }\n\n  async getAllLinks(): Promise\u003cArray\u003cLink\u003e\u003e {\n    return this.linksRepository.find({});\n  }\n}\n```\n\nHere we did a dependency injection, we injected the links repository into our service via the `constructor` with the help of the `@InjectRepository` decorator provided by `@nestjs/typeorm`. We then use the links repository to make a database call to find all the links and return it. Notice that we have used our `Link` entity as the return type as well.\n\nWe can further shorten the injection of the repository by doing it like this:\n\n```ts\n...\nexport class LinksService {\n  constructor(\n    @InjectRepository(LinksRepository) private readonly linksRepository: LinksRepository,\n  ) {}\n\n  ...\n}\n```\n\nNow go to `src/links/links.controller.ts` and let's import the `LinksService` like this:\n\n```ts\nimport { Controller } from '@nestjs/common';\nimport { LinksService } from './links.service';\n\n@Controller('links')\nexport class LinksController {\n  constructor(private readonly linksService: LinksService) {}\n}\n```\n\nNow that `LinksService` is injected into our controller, we can now use it for our `GET` request. In order to accept incoming `GET` requests, we can use the `Get()` decorator provided by Nest.\n\nLet's now update `src/links/links.controller.ts` to accept a `GET` request from `/links`, here's the code:\n\n```ts\nimport { Controller, Get } from '@nestjs/common';\nimport { LinksService } from './links.service';\n\n@Controller('links')\nexport class LinksController {\n  constructor(private readonly linksService: LinksService) {}\n\n  @Get()\n  getAllLinks() {\n    return this.linksService.getAllLinks();\n  }\n}\n```\n\nThat's how simple it is in Nest! You can open your Postman API client and do a `GET` request to `http://localhost:3000/links`. Remember that your server must be running by executing the command `yarn start:dev` on your terminal.\n\nIt should return a status of `200 OK` and return you an empty array `[]` because we didn't create any links yet.\n\n## Create a link feature\n\nThe next feature we need to implement now is to be able to create a link. Let's create a new function in `src/links/links.service.ts`:\n\n```ts\n...\n\n@Injectable()\nexport class LinksService {\n  ...\n\n  createLink(name: string, url: string): Link {\n    const link = this.linksRepository.create({\n      name,\n      url,\n    });\n\n    await this.linksRepository.save(link);\n\n    return link;\n  }\n}\n```\n\nNow `createLink` function is ready to be used. Let's go and update `src/links/links.controller.ts` to accept a `POST` request from `/links`, here's the code:\n\n```ts\nimport { Body, Controller, Get, Post } from '@nestjs/common';\n...\nexport class LinksController {\n  ...\n\n  @Post()\n  createLink(\n    @Body('name') name: string,\n    @Body('url') url: string,\n  ): Promise\u003cLink\u003e {\n    return this.linksService.createLink(name, url);\n  }\n}\n\n```\n\n`@Body` is another decorator from Nest which we can use to get a field from the request body or payload.\n\nAfter saving the changes. Let's again open our Postman API client and do a `POST` request to `http://localhost:3000/links` with a [JSON](https://en.wikipedia.org/wiki/JSON) object containing `name` and `url`.\n\n```json\n{\n  \"name\": \"longestintheworld\",\n  \"url\": \"https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/\"\n}\n```\n\nIt should return a status of `201 Created` and return you with the same JSON object with an `id`, something like this:\n\n```json\n{\n  \"name\": \"longestintheworld\",\n  \"url\": \"https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/\",\n  \"id\": \"2541f387-1ff5-4049-b64c-a3afaf440821\"\n}\n```\n\nIf you do a `GET` request to `http://localhost:3000/links`, it should now return an array containing the same JSON object above.\n\n```json\n[\n  {\n    \"name\": \"longestintheworld\",\n    \"url\": \"https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/\",\n    \"id\": \"2541f387-1ff5-4049-b64c-a3afaf440821\"\n  }\n]\n```\n\nCool! This means everything is working properly as expected.\n\nTo keep things simple in the links service and make it easier to write tests later on, let's move the code that creates the links as a custom method to our links repository `srcs/links/links.repository.ts`:\n\n```ts\n...\nexport class LinksRepository extends Repository\u003cLink\u003e {\n  async createLink(name: string, url: string): Promise\u003cLink\u003e {\n    const link = this.create({\n      name,\n      url,\n    });\n\n    await this.save(link);\n\n    return link;\n  }\n}\n```\n\nAnd then update the links service file `src/links/links.service.ts` like this:\n\n```ts\n...\nexport class LinksService {\n  ...\n\n  async createLink(name: string, url: string): Promise\u003cLink\u003e {\n    return this.linksRepository.createLink(name, url);\n  }\n}\n```\n\nYou can open your Postman API client and do the previous requests we did earlier (use a unique `name` for every new link) and everything should still work properly as before. Cool! Let's continue ~\n\n## Data Transfer Objects (DTO)\n\nYou may have already noticed how many times we had to refer to the properties of a link within our code, in particular, the `name` and `url` is passed around from the controller to the service, just to create the link. In the real-world, requirements change and having multiple reference at difference places adds complexity to our application and makes it more difficult to maintain and scale it.\n\nThis is how [Data Transfer Objects (DTO)](https://en.wikipedia.org/wiki/Data_transfer_object) saves us from this complexity. It is a common concept in software development that is not specific to Nest. Not only it is helpful for encapsulating data between processes but can also be useful for data validations. Do note that DTO is not a model definition but defines the shape of data for a specific process, for example - creating a link.\n\nDTO, similar to model, can defined as classes or interfaces. As per Nest documentation, the recommended approach is to use classes. So let's go with that.\n\n## Implement CreateLinkDto\n\nNow let's create the DTO for creating a link. Create a file `src/links/dto/create-link.dto.ts` and add the following code below:\n\n```ts\nexport class CreateLinkDto {\n  name: string;\n  url: string;\n}\n```\n\nTo make use of this DTO, let's update our repository `src/links/links.repository.ts`:\n\n```ts\n...\nimport { CreateLinkDto } from './dto/create-link.dto';\n\n@EntityRepository(Link)\nexport class LinksRepository extends Repository\u003cLink\u003e {\n  async createLink(createLinkDto: CreateLinkDto): Promise\u003cLink\u003e {\n    const { name, url } = createLinkDto;\n    const link = this.create({\n      name,\n      url,\n    });\n\n    ...\n  }\n}\n```\n\nThen update our service `src/links/links.service.ts`:\n\n```ts\n...\nimport { CreateLinkDto } from './dto/create-link.dto';\n\n@Injectable()\nexport class LinksService {\n  ...\n\n  async createLink(createLinkDto: CreateLinkDto): Promise\u003cLink\u003e {\n    return this.linksRepository.createLink(createLinkDto);\n  }\n}\n```\n\nAnd lastly update our controller `src/links/links.controller.ts`:\n\n```ts\n...\nimport { CreateLinkDto } from './dto/create-link.dto';\n\n@Controller('links')\nexport class LinksController {\n  ...\n\n  @Post()\n  createLink(@Body() createLinkDto: CreateLinkDto): Promise\u003cLink\u003e {\n    return this.linksService.createLink(createLinkDto);\n  }\n}\n```\n\nYou can open your Postman API client again and do the previous requests we did earlier (use a unique `name` for every new link) and everything should still work properly as before. Great!\n\n## Redirect to URL by name feature\n\nNow let's create the feature that makes our application a URL shortener. And that is to redirect to the actual URL by its (short) name, or if we combine with the [domain](https://en.wikipedia.org/wiki/Domain_name), by its short URL.\n\nGo to `src/links/links.service.ts` and create a new function:\n\n```ts\n...\nimport { FindConditions } from 'typeorm';\n\n@Injectable()\nexport class LinksService {\n  ...\n\n  async getLink(conditions: FindConditions\u003cLink\u003e): Promise\u003cLink\u003e {\n    return this.linksRepository.findOne(conditions);\n  }\n}\n```\n\nWe defined the type of the argument of our newly created function as `FindConditions\u003cLink\u003e`, this is so we could reuse the same function later on for when we update a link via its `id`.\n\nWe need to create another module with a controller that can handle the redirection logic. This controller will not have a path name (e.g. `/links`) so that our URL can be as short as possible. While we can have the a short domain that points to our server, we also don't need another level of path (e.g. `/links/my-short-url`) as part of the generated short URL.\n\nUsing what we've learned so far for creating a module and controller, let's once again use Nest CLI:\n\n```bash\nnest g module wildcard\nnest g controller wildcard --no-spec\n```\n\nLet's make a minor update to the generated controller `src/wildcard/wildcard.controller.ts` to remove the path argument from the `@Controller` decorator:\n\n```ts\n...\n\n@Controller()\nexport class WildcardController {}\n```\n\nTo use functions from `LinksService` to other controllers, we need to export it from its module in `src/links/links.module.ts` like this:\n\n```ts\n...\n\n@Module({\n  ...\n  exports: [LinksService],\n})\nexport class LinksModule {}\n```\n\nAnd then import the `LinksModule` in `src/wildcard/wildcard.module.ts` like this:\n\n```ts\n...\nimport { LinksModule } from 'src/links/links.module';\n\n@Module({\n  imports: [LinksModule],\n  controllers: [WildcardController],\n})\nexport class WildcardModule {}\n```\n\nFinally, let's update `src/wildcard/wildcard.controller.ts` once again to handle the URL shortener logic by using the `LinksService` function of getting the link by its (short) name:\n\n```ts\nimport { Controller, Get, Param, Res } from '@nestjs/common';\nimport { Response } from 'express';\nimport { LinksService } from 'src/links/links.service';\n\n@Controller()\nexport class WildcardController {\n  constructor(private readonly linksService: LinksService) {}\n\n  @Get('/:name')\n  async handleRedirect(\n    @Param('name') name: string,\n    @Res() res: Response\n  ): Promise\u003cvoid\u003e {\n    const link = await this.linksService.getLink({ name });\n    return res.redirect(301, link.url);\n  }\n}\n```\n\nLet's again open our Postman API client. Do a `GET` request to `http://localhost:3000/longestintheworld`, it should return a status of `200 OK` and return you some HTML code. That means our URL shortener application is doing what it is intended to do. You can also try it on your browser, visit `http://localhost:3000/longestintheworld`, and you'll get redirected to `https://llanfairpwllgwyngyllgogerychwyrndrobwllllantysiliogogogoch.co.uk/`.\n\nYou might be wondering why not just use the `AppController` from earlier? That's because if we create the controller there (e.g. `Get('/:name')`), it will take precedence against all GET requests from other controllers. For example, a GET request to `/links` will be routed to the `AppController` instead of the `LinksController` which is not ideal. That's why we had to create `WildcardController` instead so that it will be created and handle routes only after other controllers first.\n\n## Delete a link feature\n\nIf we can create links, we should be able to delete them as well. Let's go ahead and implement the feature to delete a link. You know the drill, let's first create the delete function in the links service `src/links/links.service.ts`:\n\n```ts\n...\nexport class LinksService {\n  ...\n\n  async deleteLink(id: string): Promise\u003cvoid\u003e {\n    await this.linksRepository.delete({ id });\n  }\n}\n```\n\nAfter we created the function in the service, we use it in the controller `src/links/links.controller.ts`:\n\n```ts\nimport { Body, Controller, Delete, Get, Param, Post } from '@nestjs/common';\n...\nexport class LinksController {\n  ...\n\n  @Delete('/:id')\n  deleteLink(@Param('id') id: string): Promise\u003cvoid\u003e {\n    return this.linksService.deleteLink(id);\n  }\n}\n```\n\nYou can open your Postman API client, do a `DELETE` request to `http://localhost:3000/links/:id`, do replace `:id` with the `id` you got from creating a link or from getting all the links. It should return a status of `200 OK`.\n\n## Implement UpdateLinkDto\n\nTo complete our set of APIs, we should be able to update a link as well. Let's first create the DTO for updating a link. Create a file `src/links/dto/update-link.dto.ts` and add the following code below:\n\n```ts\nexport class UpdateLinkDto {\n  name: string;\n  url: string;\n}\n```\n\nAlthough it's the same shape as `CreateLinkDto` right now, it is still a good idea to separate them per use case so that it is future-proof.\n\n## Update a link feature\n\nNow we can update the service `src/links/links.service.ts` to add the feature to update a link:\n\n```ts\n...\nimport { UpdateLinkDto } from './dto/update-link.dto';\n\n@Injectable()\nexport class LinksService {\n  ...\n\n  async updateLink(id: string, updateLinkDto: UpdateLinkDto): Promise\u003cLink\u003e {\n    const link = await this.getLink({ id });\n    const { name, url } = updateLinkDto;\n\n    link.name = name;\n    link.url = url;\n\n    await this.linksRepository.save(link);\n\n    return link;\n  }\n}\n```\n\nThen update the controller `src/links/links.controller.ts` to use the function from the service:\n\n```ts\nimport {\n  Body,\n  Controller,\n  Delete,\n  Get,\n  Param,\n  Post,\n  Put,\n} from '@nestjs/common';\nimport { UpdateLinkDto } from './dto/update-link.dto';\n...\nexport class LinksController {\n  ...\n\n  @Put('/:id')\n  updateLink(\n    @Param('id') id: string,\n    @Body() updateLinkDto: UpdateLinkDto\n  ): Link {\n    return this.linksService.updateLink(id, updateLinkDto);\n  }\n}\n```\n\nYou can open your Postman API client, repeat the steps previously for creating a link, remember to get the `id` as we'll need it later. Then do a `UPDATE` request to `http://localhost:3000/links/:id`, do replace `:id` with the `id` you got from creating a link or from getting all the links, with a JSON object containing `name` and `url`:\n\n```json\n{\n  \"name\": \"shortestintheworld\",\n  \"url\": \"https://u.nu/\"\n}\n```\n\nIt should return a status of `200 OK`. When you do a request to get all the links, the updated link should be returned in the response.\n\n## Nest Pipes\n\nCurrently, we don't have any validations when creating a link. That is not ideal. Let's implement validations and error handling within our application and there's a good feature from Nest we can use for such cases and that is [Pipes](https://docs.nestjs.com/pipes#built-in-pipes).\n\nBased from Nest documentation, we can say that:\n\n- Pipes operate on the arguments being processed by a controller route handler, just before the handler is called.\n- Pipes can perform **data transformation** or **data validation**.\n- Pipes can return data - either _original_ or _modified_ - which will be passed on to the route handler. Pipes can throw exceptions. Exceptions thrown will be handled by Nest and parsed into an error response.\n- Pipes can be asynchronous.\n- You can build your own [custom pipes](https://docs.nestjs.com/pipes#custom-pipes).\n- Pipes can on the parameter-level, handler-level and application level (global).\n\nYou can read more about pipes and how they operate right [here](https://docs.nestjs.com/pipes).\n\nNest comes with a number of [built-in-pipes](https://docs.nestjs.com/pipes#built-in-pipes) that we can use out-of-the-box. One of them is `ValidationPipe` which we'll be using in a bit.\n\n## Validation when creating and updating a link\n\nAs mentioned above, we need to implement a validation when creating a link. Let's first install the following packages that we'll be using:\n\n```bash\nyarn add class-validator class-transformer\n```\n\n`class-validator` is a really great package that allows use of decorator and non-decorator based validation, you can head over to their [GitHub page](https://github.com/typestack/class-validator) to learn more. We'll be using one of their decorators in our classes to define our validation.\n\nLet's go over to `src/links/dto/create-link.dto.ts` and import one of the decorators from `class-validator`:\n\n```ts\nimport { IsNotEmpty, IsString, IsUrl } from 'class-validator';\n\nexport class CreateLinkDto {\n  @IsNotEmpty()\n  @IsString()\n  name: string;\n\n  @IsNotEmpty()\n  @IsUrl()\n  url: string;\n}\n```\n\nDon't forget to update `src/links/dto/update-link.dto.ts` with the same changes as well.\n\nFrom `class-validator` library, `@IsNotEmpty()` basically checks if the given value is not empty (`!== ''`, `!== null`, `!== undefined`), `@IsString()` checks if the given value is a string while `@IsUrl()` checks if the given value is a url.\n\nOur Nest app does not know what to do with these decorators yet until we use the `ValidationPipe`, we'll need to add it in the application level since it is going to be utilized to most of our handlers. Go to `src/main.ts` and update with the following code:\n\n```ts\nimport { Logger, ValidationPipe } from '@nestjs/common';\n...\n\nasync function bootstrap() {\n  const logger = new Logger();\n  const app = await NestFactory.create(AppModule);\n  const port = process.env.PORT;\n\n  app.useGlobalPipes(new ValidationPipe());\n\n  ...\n}\nbootstrap();\n```\n\nAlright, let's test out the validations. Let's open our Postman API client and do a `POST` request to `http://localhost:3000/links` without a body. It should return a status of `400 Bad Request` and return you with a JSON object like this:\n\n```json\n{\n  \"statusCode\": 400,\n  \"message\": [\n    \"name must be a string\",\n    \"name should not be empty\",\n    \"url must be an URL address\",\n    \"url should not be empty\"\n  ],\n  \"error\": \"Bad Request\"\n}\n```\n\nAs you can see, it comes with nice and descriptive error messages. This can definitely save us some time rather than us coming up with these messages.\n\n## Error handling if link already exists\n\nFor creating a link, we also need to handle the case where we create a link with a `name` that already exists in our database. Currently if we created a link twice with the same `name`, the last request would throw an `500 Internal Server Error`. Obviously, we don't want to show that to our users. If you check the terminal logs from our NestJS app, you should see something like this: `ERROR [ExceptionsHandler] duplicate key value violates unique constraint \"UQ_519b799f714024e18a740e8cca7\"`, so basically PostgreSQL has thrown an error and we did not handle it. So to fix that, let's update `srcs/links/links.repository.ts` with the following code:\n\n```ts\n...\nimport {\n  ConflictException,\n  InternalServerErrorException,\n} from '@nestjs/common';\n\n@EntityRepository(Link)\nexport class LinksRepository extends Repository\u003cLink\u003e {\n  async createLink(createLinkDto: CreateLinkDto): Promise\u003cLink\u003e {\n    ...\n\n    try {\n      await this.save(link);\n    } catch (err) {\n      if (err.code === '23505') {\n        throw new ConflictException('Short name already exists');\n      } else {\n        throw new InternalServerErrorException();\n      }\n    }\n\n    return link;\n  }\n}\n```\n\nSo by wrapping the `save()` function in a `try/catch` we are able to get the error code from PostgreSQL. Based from [PostgreSQL documentation](https://www.postgresql.org/docs/current/errcodes-appendix.html), `23505` is a unique constraint violation. So we have thrown a `ConflictException` which is from `@nestjs/common` with a descriptive error message. For any other cases we will throw an `InternalServerErrorException`, which is the default error for internal server error.\n\nOnce you saved the changes and do a `POST` request to `http://localhost:3000/links` **_twice_** with the same body or payload, it should return a status of `409 Conflict` and return you with a JSON object like this:\n\n```json\n{\n  \"statusCode\": 409,\n  \"message\": \"Short name already exists\",\n  \"error\": \"Conflict\"\n}\n```\n\n## Error handling if link does not exist\n\nFor getting, updating or deleting a link, we also need to handle the case where we get a link by an `id` or a `name` that does not exist in our database. We can simply do that by updating `src/links/links.service.ts` with the following:\n\n```ts\nimport { Injectable, NotFoundException } from '@nestjs/common';\n...\nexport class LinksService {\n  ...\n\n  async getLink(conditions: FindConditions\u003cLink\u003e): Promise\u003cLink\u003e {\n    const link = await this.linksRepository.findOne(conditions);\n\n    if (!link) {\n      throw new NotFoundException();\n    }\n\n    return link;\n  }\n\n  ...\n}\n```\n\nOnce you saved the changes and do a `GET` request to `http://localhost:3000/doesnotexist`, it should return a status of `404 Not Found` and return you with a JSON object like this:\n\n```json\n{\n  \"statusCode\": 404,\n  \"message\": \"Not Found\"\n}\n```\n\nSo by just from throwing a `NotFoundException` from Nest, it will bubble up and automatically construct this JSON object for us to return to the client. We didn't even had to touch our controller to handle this which is the right way based from what we said earlier about services handling the business logics. Since we are reusing `getLink` method when updating a link, it will also handle cases where link does not exist.\n\nYou can also try updating a link by an `id` that does not exist and you will get the same response. Do note that if you try to pass an `id` that's not in `uuid` format, you will still get `500 Internal Server Error`. To fix that, we can create a new DTO `src/links/dto/get-link.dto.ts` and add the following code below:\n\n```ts\nimport { IsUUID } from 'class-validator';\n\nexport class GetLinkDto {\n  @IsUUID()\n  id: string;\n}\n```\n\nAnd update our controller `src/links/links.controller.ts` methods that gets `id` from the parameters:\n\n```ts\n...\nimport { GetLinkDto } from './dto/get-link.dto';\n\n@Controller('links')\nexport class LinksController {\n  ...\n\n  @Delete('/:id')\n  deleteLink(@Param() getLinkDto: GetLinkDto): Promise\u003cvoid\u003e {\n    return this.linksService.deleteLink(getLinkDto);\n  }\n\n  @Put('/:id')\n  updateLink(\n    @Param() getLinkDto: GetLinkDto,\n    @Body() updateLinkDto: UpdateLinkDto,\n  ): Promise\u003cLink\u003e {\n    return this.linksService.updateLink(getLinkDto, updateLinkDto);\n  }\n}\n```\n\nAnd update our service `src/links/links.service.ts` methods as well:\n\n```ts\n...\nimport { GetLinkDto } from './dto/get-link.dto';\n\n@Injectable()\nexport class LinksService {\n  ...\n\n  async deleteLink(getLinkDto: GetLinkDto): Promise\u003cvoid\u003e {\n    const { id } = getLinkDto;\n    await this.linksRepository.delete({ id });\n  }\n\n  async updateLink(\n    getLinkDto: GetLinkDto,\n    updateLinkDto: UpdateLinkDto,\n  ): Promise\u003cLink\u003e {\n    const { id } = getLinkDto;\n    const link = await this.getLink({ id });\n    ...\n  }\n}\n```\n\nIt should now return a `400 Bad Request` if you pass an `id` that's not in `uuid` format:\n\n```json\n{\n  \"statusCode\": 400,\n  \"message\": [\"id must be a UUID\"],\n  \"error\": \"Bad Request\"\n}\n```\n\nLastly, we should also return a `404 Not Found` error if we are deleting a link that no longer exists. We can do that by updating the method in `src/links/links.service.ts`:\n\n```ts\n...\nexport class LinksService {\n  ...\n\n  async deleteLink(getLinkDto: GetLinkDto): Promise\u003cvoid\u003e {\n    const { id } = getLinkDto;\n    const res = await this.linksRepository.delete({ id });\n\n    if (res.affected === 0) {\n      throw new NotFoundException(`Link with ID: \"${id}\" not found`);\n    }\n  }\n\n  ...\n}\n\n```\n\nAs you can see, we can add custom message as an argument for `NotFoundException` object and we'll get an JSON object for the error like this:\n\n```json\n{\n  \"statusCode\": 404,\n  \"message\": \"Link with ID: \\\"3232c642-ec07-4e8d-87a2-010cd5c033d2\\\" not found\",\n  \"error\": \"Not Found\"\n}\n```\n\nWe've completed the set of APIs for our URL shortener application. It's now time to write tests!\n\nProceed to the [next part](/posts/building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-2).\n","previousPost":{"id":"local-development-setup-for-nestjs-projects-with-postgresql","title":"Local development setup for NestJS projects with PostgreSQL","date":"2022-04-15","excerpt":"A quick way to get started with NestJS integrated with TypeScript, PostgreSQL and pgAdmin4 using Docker Compose","category":"technology","videoUrl":"https://youtu.be/pZNE1YMdbio"},"nextPost":{"id":"building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-2","title":"Building a URL shortener API with NestJS and PostgreSQL with tests (Part 2)","date":"2022-05-18","excerpt":"Learn how to build server-side applications in an efficient, reliable and scalable way","category":"technology","videoUrl":"https://youtu.be/ysvUh_z7wjc"},"title":"Building a URL shortener API with NestJS and PostgreSQL with tests (Part 1)","date":"2022-05-18","excerpt":"Learn how to build server-side applications in an efficient, reliable and scalable way","category":"technology","videoUrl":"https://youtu.be/c81MhWCuHbI"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"building-a-link-shortener-api-with-nestjs-and-postgresql-with-tests-part-1"},"buildId":"kLZQeYg71KvpakYRIR0ds","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>